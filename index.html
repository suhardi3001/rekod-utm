<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Rekod Log & Pinjaman</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .hidden-section { display: none !important; }
        
        /* Table Styles */
        .table-container { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        table { width: 100%; min-width: 800px; border-collapse: collapse; }
        th, td { white-space: normal !important; word-wrap: break-word; overflow-wrap: break-word; vertical-align: top; padding: 0.75rem; }

        /* Loader */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Rope Animation */
        .rope-container { width: 200px; height: 60px; margin: 0 auto 10px; position: relative; }
        .rope-path { fill: none; stroke: #9ca3af; stroke-width: 6; stroke-linecap: round; transition: all 1.5s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .knot-path { fill: none; stroke: #3b82f6; stroke-width: 6; stroke-linecap: round; opacity: 0; transform-origin: center; transform: scale(0.5); transition: all 0.5s ease-out 1s; }
        .connected .rope-left { transform: translateX(35px); stroke: #3b82f6; }
        .connected .rope-right { transform: translateX(-35px); stroke: #3b82f6; }
        .connected .knot-path { opacity: 1; transform: scale(1); }
        .connected-text { color: #3b82f6; font-weight: bold; transition: color 0.5s; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Container for Login Page (Loaded from login.html) -->
    <div id="login-container"></div>

    <!-- Main App Layout (Hidden until logged in) -->
    <div id="app-layout" class="hidden-section min-h-screen flex flex-col w-full">
        <!-- Navbar -->
        <nav class="bg-blue-800 text-white shadow-lg sticky top-0 z-50">
            <div class="w-full px-4 sm:px-6 lg:px-8"> 
                <div class="flex flex-col md:flex-row items-center justify-between h-auto md:h-16 py-2 md:py-0">
                    <div class="flex flex-col md:flex-row items-center w-full md:w-auto">
                        <span class="font-bold text-lg md:text-xl mb-2 md:mb-0 text-center md:text-left">Sistem Rekod HELPDESK iGFMAS</span>
                        <div class="md:ml-10 flex flex-wrap justify-center gap-2">
                            <button onclick="switchMainTab('call-log')" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-700 bg-blue-900 transition flex-grow md:flex-grow-0" id="nav-call-log">Call Log</button>
                            <button onclick="switchMainTab('loan')" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-700 transition flex-grow md:flex-grow-0" id="nav-loan">Pinjaman ICT</button>
                        </div>
                    </div>
                    <div class="mt-2 md:mt-0 flex items-center justify-center w-full md:w-auto">
                        <span id="user-display" class="text-xs md:text-sm mr-4 text-blue-200 truncate max-w-[150px]"></span>
                        <button onclick="handleLogout()" class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-sm whitespace-nowrap">Keluar</button>
                    </div>
                </div>
            </div>
        </nav>

        <main class="flex-grow p-4 md:p-6 w-full mx-auto">
            <!-- Container for Call Log Page (Loaded from calllog.html) -->
            <div id="call-log-container"></div>
            
            <!-- Container for Pinjaman Page (Loaded from pinjaman.html) -->
            <div id="pinjaman-container" class="hidden-section"></div>
        </main>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white px-6 py-3 rounded shadow-lg transform translate-y-20 transition duration-300 opacity-0 z-50">Notification</div>

    <script>
        // CONFIGURATION
        const supabaseUrl = 'https://objxfgosatmasjjifkkg.supabase.co'; 
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ianhmZ29zYXRtYXNqamlma2tnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMTI1MDYsImV4cCI6MjA4MDU4ODUwNn0.Y6nVvZLbqXu4yvDaL1xXrbN7Kdl73Z-Y5HC5z56vzmw';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
        let currentUser = null;

        // Load Components
        async function loadComponent(id, file) {
            try {
                const response = await fetch(file);
                const html = await response.text();
                document.getElementById(id).innerHTML = html;
                lucide.createIcons(); // Refresh icons
            } catch (err) {
                console.error(`Error loading ${file}:`, err);
            }
        }

        // Initialization
        document.addEventListener('DOMContentLoaded', async () => {
            await Promise.all([
                loadComponent('login-container', 'login.html'),
                loadComponent('call-log-container', 'calllog.html'),
                loadComponent('pinjaman-container', 'pinjaman.html')
            ]);
            
            checkAuth(); // Auth check is in main script but uses elements from login.html
        });

        // Global Navigation Logic
        window.switchMainTab = function(tabId) {
            document.getElementById('nav-call-log').classList.remove('bg-blue-900');
            document.getElementById('nav-loan').classList.remove('bg-blue-900');
            
            // Hide Containers (These are the wrapper divs in index.html)
            document.getElementById('call-log-container').classList.add('hidden-section');
            document.getElementById('pinjaman-container').classList.add('hidden-section');

            if (tabId === 'call-log') {
                document.getElementById('nav-call-log').classList.add('bg-blue-900');
                document.getElementById('call-log-container').classList.remove('hidden-section');
                // Re-trigger default subtab if needed
                 if(typeof switchCallLogTab === 'function') switchCallLogTab('search');
            } else if (tabId === 'loan') {
                document.getElementById('nav-loan').classList.add('bg-blue-900');
                document.getElementById('pinjaman-container').classList.remove('hidden-section');
                 if(typeof switchLoanTab === 'function') switchLoanTab('loan-tab-borrow');
            }
        };

        // Shared Utils
        window.showToast = function(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.remove('opacity-0', 'translate-y-20');
            setTimeout(() => { t.classList.add('opacity-0', 'translate-y-20'); }, 3000);
        };
        
        window.handleLogout = async function() {
            await supabase.auth.signOut();
            window.location.reload();
        }

        // Auth Logic (Kept in Main to control visibility)
        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                currentUser = session.user;
                document.getElementById('login-container').classList.add('hidden-section');
                document.getElementById('app-layout').classList.remove('hidden-section');
                document.getElementById('user-display').textContent = currentUser.email;
                switchMainTab('call-log');
            }
        }
    </script>
</body>
</html>
