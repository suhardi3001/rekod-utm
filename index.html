<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Rekod IT UTM (v31 - Loan Dropdown Fixed)</title>
    
    <!-- EXTERNAL LIBRARIES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root { --base-font-size: 16px; }
        html { font-size: var(--base-font-size); }
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; overflow-x: auto; }
        
        .no-wrap-content, th, td, label { white-space: nowrap !important; }
        .hidden-section { display: none !important; }
        
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%;
            width: 40px; height: 40px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .login-btn-anim.loading { background-color: #000 !important; color: transparent !important; pointer-events: none; }
        .login-btn-anim.loading::after {
            content: "UTM"; position: absolute; color: #E50914; font-weight: 900; font-size: 1.5rem;
            animation: netflix-zoom 2s ease-in-out infinite;
        }
        @keyframes netflix-zoom { 0%, 100% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.2); opacity: 1; } }

        .tab-active-main { background-color: #1e3a8a !important; color: white; }
        .tab-active-sub { color: #2563eb !important; border-bottom: 2px solid #2563eb !important; }
        
        .table-container { width: 100%; overflow-x: auto; border: 1px solid #e5e7eb; background: white; }
        table { border-collapse: collapse; width: max-content; min-width: 100%; }
        
        th.draggable-header { cursor: grab; position: relative; transition: background-color 0.2s; }
        th.drag-over { border-left: 3px solid #3b82f6; background-color: #eff6ff; }
        
        #debug-console { background: #1a1a1a; color: #00ff00; font-family: monospace; height: 120px; overflow-y: auto; font-size: 11px; padding: 10px; border-radius: 8px; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- 1. INDEX / LOADING -->
    <div id="index-page" class="flex-grow flex flex-col items-center justify-center bg-white">
        <div class="loader mb-4"></div>
        <h1 class="text-xl font-bold text-gray-800">Sistem Rekod UTM</h1>
        <p class="text-gray-500 text-sm">Menghubungi Pangkalan Data...</p>
    </div>

    <!-- 2. LOGIN -->
    <div id="login-page" class="hidden-section flex-grow flex flex-col items-center justify-center p-4">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-2xl font-bold text-gray-800">Sistem Rekod IT</h1>
                <p class="text-gray-500 text-sm">Unit Teknologi Maklumat</p>
            </div>
            <form id="login-form" class="space-y-6">
                <div><label class="block text-sm font-bold mb-2">Email</label><input type="email" id="email" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required></div>
                <div><label class="block text-sm font-bold mb-2">Password</label><input type="password" id="password" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required></div>
                <div id="login-error" class="text-red-500 text-sm hidden bg-red-100 p-3 rounded"></div>
                <button type="submit" id="login-btn" class="login-btn-anim w-full bg-blue-600 text-white font-bold py-3 rounded-lg flex items-center justify-center">Log Masuk</button>
            </form>
            <div id="debug-console" class="mt-6"><div>> System ready.</div></div>
        </div>
    </div>

    <!-- 3. MAIN APP -->
    <div id="main-page" class="hidden-section min-h-screen flex flex-col">
        <nav class="bg-blue-800 text-white shadow-lg sticky top-0 z-50">
            <div class="w-full px-4 py-2 flex flex-col md:flex-row justify-between items-center">
                <div class="flex items-center">
                    <span class="font-bold text-lg mr-6">Rekod UTM</span>
                    <div class="flex gap-2">
                        <button onclick="Navigation.switchModule('call-log')" id="nav-call-log" class="px-3 py-1 rounded text-sm font-medium tab-active-main">Call Log</button>
                        <button onclick="Navigation.switchModule('loan')" id="nav-loan" class="px-3 py-1 rounded text-sm font-medium">Pinjaman ICT</button>
                    </div>
                </div>
                <div class="flex items-center gap-4 text-sm">
                    <div class="flex gap-1">
                        <button onclick="UI.adjustFontSize(-1)" class="bg-white/10 px-2 py-1 rounded hover:bg-white/20">A-</button>
                        <button onclick="UI.adjustFontSize(1)" class="bg-white/10 px-2 py-1 rounded hover:bg-white/20">A+</button>
                    </div>
                    <span id="user-display" class="hidden md:inline text-blue-200"></span>
                    <button onclick="Auth.logout()" class="bg-red-600 px-3 py-1 rounded font-bold">Keluar</button>
                </div>
            </div>
        </nav>

        <main class="flex-grow p-4 md:p-6">
            
            <!-- CALL LOG MODULE -->
            <div id="call-log-module" class="w-full">
                <div class="flex border-b mb-6 bg-white rounded-t-lg">
                    <button onclick="Navigation.switchSubTab('call-log', 'input')" id="tab-cl-input" class="px-6 py-3 font-bold tab-active-sub">INPUT</button>
                    <button onclick="Navigation.switchSubTab('call-log', 'records')" id="tab-cl-records" class="px-6 py-3 font-bold text-gray-400">REKOD</button>
                </div>

                <div id="cl-input-section">
                    <div class="bg-white p-6 rounded-lg shadow border mb-6">
                        <h2 class="text-lg font-bold mb-4 flex gap-2 items-center"><i data-lucide="search"></i> Carian Personnel</h2>
                        <div class="relative">
                            <input type="text" id="global-search" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Cari Nama, IC, atau Kod PTJ...">
                            <div id="search-results-dropdown" class="absolute z-50 w-full bg-white shadow-2xl rounded-b-lg border hidden max-h-60 overflow-y-auto mt-1"></div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow border">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-lg font-bold flex gap-2 items-center"><i data-lucide="file-text"></i> Maklumat Isu</h2>
                            <button id="btn-update-master" onclick="CallLog.updateMasterData()" class="hidden bg-yellow-500 text-white text-xs px-3 py-1 rounded font-bold flex items-center gap-1 hover:bg-yellow-600"><i data-lucide="save" class="w-3 h-3"></i> Simpan ke Data Induk</button>
                        </div>
                        <form id="data-form">
                            <input type="hidden" id="is-new-user" value="false">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                                <div class="space-y-4">
                                    <h3 class="font-bold text-gray-400 text-xs uppercase">Maklumat Pengguna</h3>
                                    <div><label class="text-xs font-bold text-gray-600">1. Nama</label><div class="relative"><input type="text" id="nama" class="w-full px-3 py-2 border rounded bg-gray-50 uppercase" readonly><button type="button" onclick="Utils.enableField('nama')" class="absolute right-2 top-2 text-gray-400"><i data-lucide="pencil" class="w-4 h-4"></i></button></div></div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div><label class="text-xs font-bold text-gray-600">2. IC</label><div class="relative"><input type="text" id="ic" class="w-full px-3 py-2 border rounded bg-gray-50" readonly><button type="button" onclick="Utils.enableField('ic')" class="absolute right-2 top-2 text-gray-400"><i data-lucide="pencil" class="w-4 h-4"></i></button></div></div>
                                        <div><label class="text-xs font-bold text-gray-600">3. Kod PTJ</label><div class="relative"><input type="text" id="kod_ptj" class="w-full px-3 py-2 border rounded bg-gray-50" readonly><button type="button" onclick="Utils.enableField('kod_ptj')" class="absolute right-2 top-2 text-gray-400"><i data-lucide="pencil" class="w-4 h-4"></i></button></div></div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div><label class="text-xs font-bold text-gray-600">4. Jabatan</label><div class="relative"><input type="text" id="department" class="w-full px-3 py-2 border rounded bg-gray-50" readonly><button type="button" onclick="Utils.enableField('department')" class="absolute right-2 top-2 text-gray-400"><i data-lucide="pencil" class="w-4 h-4"></i></button></div></div>
                                        <div><label class="text-xs font-bold text-gray-600">5. Emel</label><div class="relative"><input type="email" id="emel" class="w-full px-3 py-2 border rounded bg-gray-50" readonly><button type="button" onclick="Utils.enableField('emel')" class="absolute right-2 top-2 text-gray-400"><i data-lucide="pencil" class="w-4 h-4"></i></button></div></div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div><label class="text-xs font-bold text-gray-600">6. Telefon</label><div class="relative"><input type="text" id="telefon" class="w-full px-3 py-2 border rounded bg-gray-50" readonly><button type="button" onclick="Utils.enableField('telefon')" class="absolute right-2 top-2 text-gray-400"><i data-lucide="pencil" class="w-4 h-4"></i></button></div></div>
                                        <div><label class="text-xs font-bold text-gray-600">7. Gred</label><div class="relative"><input type="text" id="gred" class="w-full px-3 py-2 border rounded bg-gray-50" readonly><button type="button" onclick="Utils.enableField('gred')" class="absolute right-2 top-2 text-gray-400"><i data-lucide="pencil" class="w-4 h-4"></i></button></div></div>
                                    </div>
                                </div>
                                <div class="bg-gray-50 p-6 rounded-lg border h-fit">
                                    <h3 class="font-bold text-gray-400 text-xs uppercase mb-4">Butiran Sistem</h3>
                                    <div class="space-y-6">
                                        <div>
                                            <div class="flex justify-between items-center mb-1"><label class="text-xs font-bold text-gray-700">Medium</label><button type="button" onclick="CallLog.toggleInput('komunikasi')" class="text-[10px] bg-blue-100 text-blue-700 px-2 py-1 rounded font-bold">+ Tambah</button></div>
                                            <div id="add-input-komunikasi" class="hidden mb-2"><input type="text" id="input-new-komunikasi" class="w-full p-2 border rounded text-xs shadow-inner" placeholder="Enter..." onkeydown="CallLog.saveOnEnter(event, 'komunikasi')"></div>
                                            <div id="container-komunikasi" class="flex flex-wrap gap-2"></div>
                                        </div>
                                        <div>
                                            <div class="flex justify-between items-center mb-1"><label class="text-xs font-bold text-gray-700">Sistem</label><button type="button" onclick="CallLog.toggleInput('sistem')" class="text-[10px] bg-blue-100 text-blue-700 px-2 py-1 rounded font-bold">+ Tambah</button></div>
                                            <div id="add-input-sistem" class="hidden mb-2"><input type="text" id="input-new-sistem" class="w-full p-2 border rounded text-xs shadow-inner" onkeydown="CallLog.saveOnEnter(event, 'sistem')"></div>
                                            <div id="container-sistem" class="grid grid-cols-2 gap-2"></div>
                                        </div>
                                        <div>
                                            <div class="flex justify-between items-center mb-1"><label class="text-xs font-bold text-gray-700">Perkara</label><button type="button" onclick="CallLog.toggleInput('perkara')" class="text-[10px] bg-blue-100 text-blue-700 px-2 py-1 rounded font-bold">+ Tambah</button></div>
                                            <div id="add-input-perkara" class="hidden mb-2"><input type="text" id="input-new-perkara" class="w-full p-2 border rounded text-xs shadow-inner" onkeydown="CallLog.saveOnEnter(event, 'perkara')"></div>
                                            <select id="issue-dropdown" class="w-full px-3 py-2 border rounded-lg bg-white text-sm">
                                                <option value="" disabled selected>-- Pilih Isu --</option>
                                            </select>
                                        </div>
                                    </div>
                                    <button type="submit" id="submit-btn" disabled class="w-full mt-8 bg-green-600 text-white font-bold py-4 rounded-xl shadow-lg opacity-50 cursor-not-allowed flex items-center justify-center gap-2">
                                        <i data-lucide="save"></i> HANTAR REKOD
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <div id="cl-records-section" class="hidden-section">
                    <div class="bg-white p-6 rounded-lg shadow border">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-lg font-bold">Pangkalan Data Rekod (Call Log)</h2>
                            <div class="flex gap-2">
                                <button onclick="Records.fetch()" class="bg-gray-100 p-2 rounded hover:bg-gray-200"><i data-lucide="refresh-cw"></i></button>
                                <button onclick="Records.exportExcel()" class="bg-green-600 text-white px-4 py-2 rounded text-xs font-bold flex items-center gap-2 hover:bg-green-700"><i data-lucide="sheet"></i> EXPORT EXCEL</button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table id="main-records-table">
                                <thead id="records-table-head" class="bg-gray-50 text-xs font-bold uppercase border-b"></thead>
                                <tbody id="records-table-body" class="text-[10px] text-gray-600"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PINJAMAN MODULE -->
            <div id="loan-module" class="hidden-section w-full">
                <div class="bg-white p-6 rounded-lg shadow border">
                    <h2 class="text-xl font-bold mb-6 flex items-center gap-2 text-gray-800"><i data-lucide="monitor-smartphone"></i> Sistem Pinjaman</h2>
                    
                    <div class="flex flex-wrap border-b mb-6 overflow-x-auto bg-gray-50 rounded-t-lg">
                        <button onclick="Navigation.switchSubTab('loan', 'borrow')" id="tab-loan-borrow" class="px-6 py-3 font-bold tab-active-sub">PINJAM</button>
                        <button onclick="Navigation.switchSubTab('loan', 'return')" id="tab-loan-return" class="px-6 py-3 font-bold text-gray-400">PULANG</button>
                        <button onclick="Navigation.switchSubTab('loan', 'admin')" id="tab-loan-admin" class="px-6 py-3 font-bold text-gray-400">ADMIN</button>
                        <button onclick="Navigation.switchSubTab('loan', 'history')" id="tab-loan-history" class="px-6 py-3 font-bold text-gray-400">SEJARAH</button>
                    </div>

                    <!-- Borrow -->
                    <div id="loan-borrow-section">
                        <form id="loanForm" class="space-y-6 bg-gray-50 p-6 rounded-xl border">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label class="block text-xs font-bold text-gray-700 mb-1">Nama Peminjam</label><input type="text" id="loanUserName" list="userList" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"><datalist id="userList"></datalist></div>
                                <div><label class="block text-xs font-bold text-gray-700 mb-1">Pilih Peranti</label><select id="deviceSelect" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required></select></div>
                                <div><label class="block text-xs font-bold text-gray-700 mb-1">Tarikh Mula</label><input type="date" id="loanStartDate" class="w-full px-4 py-2 border rounded-lg"></div>
                                <div><label class="block text-xs font-bold text-gray-700 mb-1">Tarikh Tamat</label><input type="date" id="loanEndDate" class="w-full px-4 py-2 border rounded-lg"></div>
                                
                                <!-- ADDED DROPDOWN FOR LUAR/DALAMAN -->
                                <div><label class="block text-xs font-bold text-gray-700 mb-1">Jenis Kegunaan</label><select id="usageType" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required><option value="Kegunaan Dalaman">Kegunaan Dalaman</option><option value="Kegunaan Luar">Kegunaan Luar</option></select></div>
                                
                                <div class="md:col-span-1"><label class="block text-xs font-bold text-gray-700 mb-1">Tujuan / Butiran Pinjaman</label><textarea id="usageDetails" rows="1" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"></textarea></div>
                            </div>
                            <button type="button" onclick="Loan.submit()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2 hover:bg-blue-700 transition-colors"><i data-lucide="send"></i> HANTAR PINJAMAN</button>
                        </form>
                    </div>

                    <!-- Return -->
                    <div id="loan-return-section" class="hidden-section">
                        <div class="bg-blue-50 border-2 border-dashed border-blue-200 rounded-2xl p-10 text-center max-w-xl mx-auto">
                            <h3 class="font-bold text-gray-800 mb-4">Pulangkan Peranti</h3>
                            <select id="returnSelect" class="w-full px-4 py-3 border rounded-xl mb-6 shadow-sm"></select>
                            <button onclick="Loan.submitReturn()" class="bg-green-600 text-white font-bold py-3 px-10 rounded-lg">SAHKAN PULANGAN</button>
                        </div>
                    </div>

                    <!-- Admin -->
                    <div id="loan-admin-section" class="hidden-section">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="space-y-4">
                                <button onclick="Loan.checkOverdueLoans()" class="w-full bg-orange-600 text-white py-2 rounded-lg font-bold">SEMAK OVERDUE</button>
                                
                                <div class="border p-4 rounded bg-gray-50 shadow-sm">
                                    <h6 class="font-bold border-b mb-4">Tambah Pengguna</h6>
                                    <div class="space-y-2">
                                        <input id="newUserName" class="w-full px-3 py-2 border rounded text-sm uppercase" placeholder="Nama Penuh">
                                        <div class="relative">
                                            <input id="newUserEmail" class="w-full px-3 py-2 border rounded text-sm pr-20" placeholder="ID Emel">
                                            <span class="absolute right-3 top-2 text-[10px] text-gray-400">@moe.gov.my</span>
                                        </div>
                                    </div>
                                    <button onclick="Loan.addUser()" class="w-full mt-3 bg-gray-800 text-white py-2 rounded font-bold text-sm">SIMPAN PENGGUNA</button>
                                </div>

                                <div class="border p-4 rounded bg-gray-50 shadow-sm">
                                    <h6 class="font-bold border-b mb-4">Tambah Peranti (Aset)</h6>
                                    <div class="space-y-2">
                                        <input id="newTag" class="w-full px-3 py-2 border rounded text-sm" placeholder="Tag Aset">
                                        <input id="newType" class="w-full px-3 py-2 border rounded text-sm" placeholder="Model">
                                        <input id="newSerial" class="w-full px-3 py-2 border rounded text-sm" placeholder="Serial Number">
                                    </div>
                                    <button onclick="Loan.addDevice()" class="w-full mt-3 bg-gray-800 text-white py-2 rounded font-bold text-sm">DAFTAR PERANTI</button>
                                </div>
                            </div>
                            
                            <div class="border p-4 bg-white rounded shadow-sm">
                                <h6 class="font-bold text-gray-800 mb-2 border-b pb-1">Pinjaman Aktif</h6>
                                <div class="table-container text-[11px]">
                                    <table class="w-full">
                                        <thead class="bg-gray-100"><tr><th class="p-2 text-left">Peminjam</th><th class="p-2 text-left">Tag</th><th class="p-2 text-left">Tamat</th></tr></thead>
                                        <tbody id="active-loans-body"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- History -->
                    <div id="loan-history-section" class="hidden-section">
                        <div class="flex justify-between items-center mb-4">
                            <h6 class="font-bold">Log Pinjaman (Full View)</h6>
                            <button onclick="Loan.exportExcel()" class="bg-green-600 text-white px-3 py-1 rounded text-xs font-bold flex items-center gap-2 hover:bg-green-700">
                                <i data-lucide="sheet" class="w-4 h-4"></i> EXPORT TO EXCEL
                            </button>
                        </div>
                        <div class="table-container">
                            <table class="text-[10px]">
                                <thead class="bg-gray-100 font-bold border-b border-gray-300">
                                    <tr><th class="p-3 text-left">Tarikh Pinjam</th><th class="p-3 text-left">Peminjam</th><th class="p-3 text-left">Tag Aset</th><th class="p-3 text-left">Tempoh</th><th class="p-3 text-left">Pengeluar</th><th class="p-3 text-left">Penerima</th><th class="p-3 text-left">Tarikh Pulang</th><th class="p-3 text-left">Status</th></tr>
                                </thead>
                                <tbody id="loan-history-body" class="bg-white"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- UTILITIES -->
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white px-6 py-4 rounded-xl shadow-2xl transform translate-y-20 transition-all opacity-0 z-[100]"></div>
    <div id="overdue-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-[100] p-4">
        <div class="bg-white rounded-xl max-w-2xl w-full p-8 shadow-2xl">
            <h3 class="text-xl font-bold text-red-600 mb-4">SENARAI OVERDUE</h3>
            <div class="table-container max-h-60 rounded border">
                <table class="text-xs w-full">
                    <thead class="bg-red-50"><tr><th class="p-2 text-left">Nama</th><th class="p-2 text-left">Aset</th><th class="p-2 text-left">Tamat</th><th class="p-2 text-center">Tindakan</th></tr></thead>
                    <tbody id="overdue-list-body"></tbody>
                </table>
            </div>
            <button onclick="document.getElementById('overdue-modal').classList.add('hidden')" class="mt-6 bg-gray-800 text-white px-6 py-2 rounded font-bold w-full">TUTUP</button>
        </div>
    </div>

    <script>
        const CONFIG = { supabaseUrl: 'https://objxfgosatmasjjifkkg.supabase.co', supabaseKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ianhmZ29zYXRtYXNqamlma2tnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMTI1MDYsImV4cCI6MjA4MDU4ODUwNn0.Y6nVvZLbqXu4yvDaL1xXrbN7Kdl73Z-Y5HC5z56vzmw' };
        const STATE = { currentUser: null, searchTimeout: null, baseFontSize: 16, userMap: {} };
        const sbClient = window.supabase.createClient(CONFIG.supabaseUrl, CONFIG.supabaseKey);

        const Utils = {
            log: (msg) => { const c = document.getElementById('debug-console'); if(c) { c.innerHTML += `<div>> ${msg}</div>`; c.scrollTop = c.scrollHeight; } },
            showToast: (msg) => { const t = document.getElementById('toast'); t.innerText = msg; t.classList.remove('opacity-0', 'translate-y-20'); setTimeout(() => t.classList.add('opacity-0', 'translate-y-20'), 3000); },
            enableField: (id) => { const el = document.getElementById(id); if(el) { el.readOnly = false; el.classList.replace('bg-gray-50', 'bg-white'); el.classList.add('ring-2', 'ring-blue-100'); el.focus(); document.getElementById('btn-update-master').classList.remove('hidden'); } },
            formatDate: (d) => d ? new Date(d).toLocaleString('ms-MY', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : '-',
            getToday: () => new Date().toISOString().split('T')[0],
            showPage: (pageId) => {
                ['index-page', 'login-page', 'main-page'].forEach(p => document.getElementById(p).classList.add('hidden-section'));
                document.getElementById(pageId).classList.remove('hidden-section');
            }
        };

        const Auth = {
            init: async () => {
                try {
                    const { data: { session }, error } = await sbClient.auth.getSession();
                    if (error) throw error;
                    if (session) Auth.onAuth(session.user);
                    else Utils.showPage('login-page');
                } catch (e) { Utils.log("Database Error: " + e.message); Utils.showPage('login-page'); }
            },
            login: async (e) => {
                e.preventDefault();
                const btn = document.getElementById('login-btn'); btn.classList.add('loading');
                const { data, error } = await sbClient.auth.signInWithPassword({ email: document.getElementById('email').value.trim(), password: document.getElementById('password').value });
                if (error) { btn.classList.remove('loading'); document.getElementById('login-error').innerText = error.message; document.getElementById('login-error').classList.remove('hidden'); }
                else Auth.onAuth(data.user);
            },
            onAuth: async (user) => {
                STATE.currentUser = user;
                document.getElementById('user-display').innerText = user.email;
                const { data: users } = await sbClient.from('user_ba').select('name, emel');
                users?.forEach(u => { if(u.emel) STATE.userMap[u.emel.toLowerCase()] = u.name; });
                Utils.showPage('main-page');
                Navigation.switchModule('call-log');
                CallLog.init();
            },
            logout: async () => { await sbClient.auth.signOut(); window.location.reload(); }
        };

        const Navigation = {
            switchModule: (mod) => {
                const isCl = mod === 'call-log';
                document.getElementById('call-log-module').classList.toggle('hidden-section', !isCl);
                document.getElementById('loan-module').classList.toggle('hidden-section', isCl);
                document.getElementById('nav-call-log').className = isCl ? 'px-3 py-1 rounded text-sm font-medium tab-active-main' : 'px-3 py-1 rounded text-sm font-medium';
                document.getElementById('nav-loan').className = !isCl ? 'px-3 py-1 rounded text-sm font-medium tab-active-main' : 'px-3 py-1 rounded text-sm font-medium';
                if (!isCl) Loan.loadData();
            },
            switchSubTab: (mod, tab) => {
                if (mod === 'call-log') {
                    const isInput = tab === 'input';
                    document.getElementById('cl-input-section').classList.toggle('hidden-section', !isInput);
                    document.getElementById('cl-records-section').classList.toggle('hidden-section', isInput);
                    document.getElementById('tab-cl-input').className = isInput ? 'px-6 py-3 font-bold tab-active-sub' : 'px-6 py-3 font-bold text-gray-400';
                    document.getElementById('tab-cl-records').className = !isInput ? 'px-6 py-3 font-bold tab-active-sub' : 'px-6 py-3 font-bold text-gray-400';
                    if (!isInput) Records.init();
                } else {
                    ['borrow','return','admin','history'].forEach(t => {
                        document.getElementById(`loan-${t}-section`).classList.toggle('hidden-section', t !== tab);
                        document.getElementById(`tab-loan-${t}`).className = t === tab ? 'px-6 py-3 font-bold tab-active-sub' : 'px-6 py-3 font-bold text-gray-400';
                    });
                    if (tab === 'history') Loan.loadHistory();
                }
            }
        };

        const UI = { adjustFontSize: (d) => { STATE.baseFontSize += d; document.documentElement.style.setProperty('--base-font-size', STATE.baseFontSize + 'px'); } };

        const CallLog = {
            options: { komunikasi: [], sistem: [], perkara: [] },
            init: async () => {
                const { data } = await sbClient.from('isu').select('*');
                const def = { komunikasi: ["Email", "Call", "WhatsApp", "Walk-in"], sistem: ["Portal", "ECP450", "ECP400", "HCP400", "SOLMAN", "BP1", "BWP"], perkara: ["ID Lock", "Masalah Role", "System Error", "Lain-lain"] };
                if (data?.length) {
                    CallLog.options.komunikasi = [...new Set(data.map(i => i.komunikasi).filter(Boolean))] || def.komunikasi;
                    CallLog.options.sistem = [...new Set(data.map(i => i.sistem).filter(Boolean))] || def.sistem;
                    CallLog.options.perkara = [...new Set(data.map(i => i.perkara).filter(Boolean))] || def.perkara;
                } else CallLog.options = def;
                CallLog.renderOptions();
            },
            renderOptions: () => {
                const renderRadio = (id, list, name) => {
                    const con = document.getElementById(id); con.innerHTML = '';
                    list.forEach(v => {
                        const l = document.createElement('label'); l.className = "flex items-center gap-2 p-2 bg-white border rounded shadow-sm text-[10px] cursor-pointer hover:bg-blue-50";
                        l.innerHTML = `<input type="radio" name="${name}" value="${v}"> ${v}`;
                        l.querySelector('input').onchange = CallLog.checkValidity;
                        con.appendChild(l);
                    });
                };
                renderRadio('container-komunikasi', CallLog.options.komunikasi, 'komunikasi');
                renderRadio('container-sistem', CallLog.options.sistem, 'system_type');
                const sel = document.getElementById('issue-dropdown'); sel.innerHTML = '<option disabled selected>-- Pilih Isu --</option>';
                CallLog.options.perkara.forEach(p => sel.appendChild(new Option(p, p)));
                sel.onchange = CallLog.checkValidity;
            },
            toggleInput: (id) => document.getElementById('add-input-' + id).classList.toggle('hidden'),
            saveOnEnter: async (e, type) => {
                if (e.key === 'Enter') {
                    const val = e.target.value.trim();
                    if(val) {
                        await sbClient.from('isu').insert([{ [type]: val }]);
                        e.target.value = ''; CallLog.init();
                        document.getElementById('add-input-'+type).classList.add('hidden');
                    }
                }
            },
            handleSearch: (q) => {
                const dd = document.getElementById('search-results-dropdown');
                if (q.length < 2) return dd.classList.add('hidden');
                if (STATE.searchTimeout) clearTimeout(STATE.searchTimeout);
                STATE.searchTimeout = setTimeout(async () => {
                    dd.classList.remove('hidden'); dd.innerHTML = '<div class="p-2 text-xs">Mencari...</div>';
                    const { data } = await sbClient.from('personnel').select('*').or(`nama.ilike.%${q}%,ic_number.ilike.%${q}%,kod_ptj.ilike.%${q}%`).limit(8);
                    dd.innerHTML = data?.length ? '' : `<div class="p-3 text-blue-600 font-bold cursor-pointer hover:bg-blue-50" onclick="CallLog.prepareNew('${q}')">+ Tambah "${q}"?</div>`;
                    data?.forEach(p => {
                        const item = document.createElement('div'); item.className = "p-2 hover:bg-gray-100 cursor-pointer border-b text-xs";
                        item.innerHTML = `<b>${p.nama}</b><br><span class="text-gray-400">${p.ic_number}</span>`;
                        item.onclick = () => CallLog.fill(p);
                        dd.appendChild(item);
                    });
                }, 300);
            },
            fill: (p) => {
                ['nama','ic','kod_ptj','department','emel','telefon','gred'].forEach(k => document.getElementById(k).value = p[k==='ic'?'ic_number':k] || '');
                document.getElementById('search-results-dropdown').classList.add('hidden'); CallLog.checkValidity();
            },
            prepareNew: (n) => { 
                document.getElementById('data-form').reset(); 
                document.getElementById('nama').value = n.toUpperCase(); 
                document.getElementById('is-new-user').value = 'true';
                ['nama','ic','kod_ptj','department','emel','telefon','gred'].forEach(id => Utils.enableField(id)); 
                document.getElementById('search-results-dropdown').classList.add('hidden'); 
            },
            checkValidity: () => {
                const btn = document.getElementById('submit-btn');
                const isValid = document.getElementById('nama').value && document.querySelector('input[name="system_type"]:checked') && document.getElementById('issue-dropdown').value;
                btn.disabled = !isValid; btn.classList.toggle('opacity-50', !isValid);
            },
            updateMasterData: async () => {
                const p = { ic_number: document.getElementById('ic').value, nama: document.getElementById('nama').value, kod_ptj: document.getElementById('kod_ptj').value, department: document.getElementById('department').value, emel: document.getElementById('emel').value, telefon: document.getElementById('telefon').value, gred: document.getElementById('gred').value };
                const { data: ex } = await sbClient.from('personnel').select('id').eq('ic_number', p.ic_number).maybeSingle();
                if(ex) await sbClient.from('personnel').update(p).eq('ic_number', p.ic_number); else await sbClient.from('personnel').insert([p]);
                Utils.showToast("Data Induk Dikemaskini"); document.getElementById('btn-update-master').classList.add('hidden');
            },
            submit: async (e) => {
                e.preventDefault();
                const log = { ic_number: document.getElementById('ic').value, nama: document.getElementById('nama').value, department: document.getElementById('department').value, perekod: STATE.currentUser.email, submitted_by: STATE.currentUser.id, sistem: document.querySelector('input[name="system_type"]:checked').value, perkara: document.getElementById('issue-dropdown').value, komunikasi: document.querySelector('input[name="komunikasi"]:checked').value, confirmation: 'TIDAK' };
                const { error } = await sbClient.from('rekod').insert([log]);
                if(!error) { CallLog.updateMasterData(); Utils.showToast("Rekod Disimpan"); document.getElementById('data-form').reset(); CallLog.checkValidity(); }
            }
        };

        const Records = {
            columns: [
                { id: 'created_at', label: 'Tarikh Event' }, { id: 'nama_ic', label: 'Nama / IC' }, { id: 'department', label: 'Jabatan' }, { id: 'komunikasi', label: 'Komunikasi' }, { id: 'sistem', label: 'Sistem' }, { id: 'perkara', label: 'Isu' }, { id: 'perekod', label: 'Direkod Oleh' }, { id: 'updated_at', label: 'Selesai Pada' }, { id: 'updated_by', label: 'Selesai Oleh' }, { id: 'status', label: 'Status' }
            ],
            init: () => { Records.renderHeader(); Records.fetch(); },
            renderHeader: () => {
                const h = document.getElementById('records-table-head'); h.innerHTML = '';
                const tr = document.createElement('tr');
                Records.columns.forEach((col, idx) => {
                    const th = document.createElement('th'); th.className = "p-2 text-left border-r draggable-header"; th.innerText = col.label; th.dataset.index = idx; th.draggable = true;
                    th.addEventListener('dragstart', (e) => { Records.dragIdx = idx; });
                    th.addEventListener('dragover', (e) => e.preventDefault());
                    th.addEventListener('drop', (e) => {
                        const dropIdx = idx;
                        const item = Records.columns.splice(Records.dragIdx, 1)[0];
                        Records.columns.splice(dropIdx, 0, item);
                        Records.init();
                    });
                    tr.appendChild(th);
                });
                h.appendChild(tr);
            },
            fetch: async () => {
                const tb = document.getElementById('records-table-body'); tb.innerHTML = '<tr><td colspan="10" class="p-8 text-center"><div class="loader mx-auto"></div></td></tr>';
                try {
                    const [ { data: r }, { data: u } ] = await Promise.all([ 
                        sbClient.from('rekod').select('*').order('created_at', { ascending: false }).limit(100),
                        sbClient.from('user_ba').select('name, emel')
                    ]);
                    if (u) u.forEach(i => { if(i.emel) STATE.userMap[i.emel.toLowerCase()] = i.name; });
                    Records.currentData = r || []; Records.renderBody();
                } catch (e) { Utils.log("Fetch Error: " + e.message); tb.innerHTML = '<tr><td colspan="10">Error loading data.</td></tr>'; }
            },
            renderBody: () => {
                const tb = document.getElementById('records-table-body'); tb.innerHTML = '';
                Records.currentData.forEach(r => {
                    const tr = document.createElement('tr'); tr.className = "border-b hover:bg-gray-50";
                    Records.columns.forEach(col => {
                        const td = document.createElement('td'); td.className = "p-2";
                        if(col.id === 'created_at') td.innerText = Utils.formatDate(r.created_at);
                        else if(col.id === 'nama_ic') td.innerHTML = `<b>${r.nama}</b><br><span class="text-gray-400">${r.ic_number}</span>`;
                        else if(col.id === 'perekod') td.innerText = STATE.userMap[r.perekod?.toLowerCase()] || r.perekod?.split('@')[0] || '-';
                        else if(col.id === 'updated_at') td.innerText = r.status_updated_at ? Utils.formatDate(r.status_updated_at) : '-';
                        else if(col.id === 'updated_by') td.innerText = STATE.userMap[r.status_updated_by?.toLowerCase()] || r.status_updated_by?.split('@')[0] || '-';
                        else if(col.id === 'status') {
                            const sel = document.createElement('select'); sel.className = `p-1 rounded font-bold ${r.confirmation === 'YA' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
                            sel.innerHTML = `<option value="YA" ${r.confirmation==='YA'?'selected':''}>YA</option><option value="TIDAK" ${r.confirmation!=='YA'?'selected':''}>TIDAK</option>`;
                            sel.onchange = (e) => Records.update(r.id, e.target.value);
                            td.appendChild(sel);
                        } else td.innerText = r[col.id] || '-';
                        tr.appendChild(td);
                    });
                    tb.appendChild(tr);
                });
            },
            update: async (id, v) => { await sbClient.from('rekod').update({ confirmation: v, status_updated_at: new Date(), status_updated_by: STATE.currentUser.email }).eq('id', id); Utils.showToast("Dikemaskini"); Records.fetch(); },
            exportExcel: () => {
                const formatted = Records.currentData.map(r => ({
                    'Tarikh Event': Utils.formatDate(r.created_at),
                    'Nama': r.nama,
                    'IC': r.ic_number,
                    'Jabatan': r.department,
                    'Komunikasi': r.komunikasi,
                    'Sistem': r.sistem,
                    'Isu': r.perkara,
                    'Direkod Oleh': STATE.userMap[r.perekod?.toLowerCase()] || r.perekod,
                    'Selesai Pada': r.status_updated_at ? Utils.formatDate(r.status_updated_at) : '-',
                    'Selesai Oleh': STATE.userMap[r.status_updated_by?.toLowerCase()] || r.status_updated_by || '-',
                    'Status': r.confirmation
                }));
                const ws = XLSX.utils.json_to_sheet(formatted);
                const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "CallLog");
                XLSX.writeFile(wb, "Rekod_UTM_CallLog.xlsx");
            }
        };

        const Loan = {
            currentHistory: [],
            loadData: async () => {
                document.getElementById('loanStartDate').min = Utils.getToday();
                try {
                    const { data: u } = await sbClient.from('user_ba').select('name').order('name');
                    const dl = document.getElementById('userList'); dl.innerHTML = '';
                    u?.forEach(i => dl.appendChild(new Option(i.name, i.name)));
                    
                    const { data: d } = await sbClient.from('device_inventory').select('*').eq('status','Tersedia').order('tag', { ascending: true });
                    const ds = document.getElementById('deviceSelect'); ds.innerHTML = '<option disabled selected>-- Pilih Peranti --</option>';
                    d?.forEach(i => ds.appendChild(new Option(`${i.tag} - ${i.type} (${i.serial || 'No S/N'})`, i.tag)));

                    const { data: ac } = await sbClient.from('rekod_pinjaman').select('device_tag, user_name').eq('status','Active');
                    const rs = document.getElementById('returnSelect'); rs.innerHTML = '<option disabled selected>-- Pilih untuk Pulangan --</option>';
                    ac?.forEach(l => rs.appendChild(new Option(`${l.device_tag} [${l.user_name}]`, l.device_tag)));
                    Loan.loadActive();
                } catch (e) { console.error(e); }
            },
            loadActive: async () => {
                const { data } = await sbClient.from('rekod_pinjaman').select('*').eq('status','Active');
                document.getElementById('active-loans-body').innerHTML = data?.map(l => `<tr class="${l.end_date < Utils.getToday() ? 'bg-red-50 text-red-700 font-bold' : 'border-b'}"><td class="p-2">${l.user_name}</td><td class="p-2">${l.device_tag}</td><td class="p-2">${l.end_date}</td></tr>`).join('') || '';
            },
            submit: async () => {
                const p = { 
                    user_name: document.getElementById('loanUserName').value, 
                    device_tag: document.getElementById('deviceSelect').value, 
                    start_date: document.getElementById('loanStartDate').value, 
                    end_date: document.getElementById('loanEndDate').value, 
                    usage_type: document.getElementById('usageType').value, // ADDED USAGE TYPE
                    usage_details: document.getElementById('usageDetails').value, 
                    status: 'Active', 
                    issued_by: STATE.currentUser.email 
                };
                if(!p.user_name || !p.device_tag) return alert("Pilih Peminjam & Peranti.");
                try {
                    const { error } = await sbClient.from('rekod_pinjaman').insert([p]);
                    if(error) throw error;
                    await sbClient.from('device_inventory').update({status:'Dipinjam'}).eq('tag', p.device_tag);
                    Utils.showToast("Pinjaman Direkod"); document.getElementById('loanForm').reset(); Loan.loadData();
                } catch(e) { alert("Error: " + e.message); }
            },
            submitReturn: async () => {
                const t = document.getElementById('returnSelect').value; if(!t) return;
                try {
                    const { data } = await sbClient.from('rekod_pinjaman').select('id').eq('device_tag', t).eq('status','Active').maybeSingle();
                    if(data) {
                        const { error } = await sbClient.from('rekod_pinjaman').update({ status:'Returned', return_date: new Date(), received_by: STATE.currentUser.email }).eq('id', data.id);
                        if(error) throw error;
                        await sbClient.from('device_inventory').update({status:'Tersedia'}).eq('tag', t);
                        Utils.showToast("Dipulangkan"); Loan.loadData();
                    }
                } catch(e) { alert("Error: " + e.message); }
            },
            loadHistory: async () => {
                const tb = document.getElementById('loan-history-body'); tb.innerHTML = '<tr><td colspan="8" class="p-8 text-center"><div class="loader mx-auto"></div></td></tr>';
                try {
                    const { data } = await sbClient.from('rekod_pinjaman').select('*').order('created_at', {ascending:false});
                    Loan.currentHistory = data || [];
                    const today = Utils.getToday();
                    
                    tb.innerHTML = data?.map(l => {
                        const isActiveLate = l.status === 'Active' && l.end_date < today;
                        const isReturnedLate = l.status === 'Returned' && l.return_date && (new Date(l.return_date).toISOString().split('T')[0] > l.end_date);
                        const isLate = isActiveLate || isReturnedLate;
                        const p_eluar = STATE.userMap[l.issued_by?.toLowerCase()] || l.issued_by?.split('@')[0] || '-';
                        const p_enerima = STATE.userMap[l.received_by?.toLowerCase()] || l.received_by?.split('@')[0] || '-';

                        return `<tr class="${isLate ? 'bg-red-50 text-red-800' : 'border-b hover:bg-gray-50'}">
                            <td class="p-3">${Utils.formatDate(l.created_at)}</td>
                            <td class="p-3 font-bold">${l.user_name}</td>
                            <td class="p-3 text-blue-600 font-bold">${l.device_tag}</td>
                            <td class="p-3">
                                ${l.start_date} hingga ${l.end_date}
                                ${isActiveLate ? '<div class="text-[9px] font-black text-red-600 mt-1 uppercase">LEWAT</div>' : ''}
                                ${isReturnedLate ? '<div class="text-[9px] font-black text-red-600 mt-1 uppercase">PULANG LEWAT</div>' : ''}
                            </td>
                            <td class="p-3">${p_eluar}</td>
                            <td class="p-3">${p_enerima}</td>
                            <td class="p-3">${l.return_date ? Utils.formatDate(l.return_date) : '-'}</td>
                            <td class="p-3 font-black uppercase text-[8px]">
                                <span class="${l.status === 'Active' ? 'text-blue-600' : 'text-gray-500'}">${l.status}</span>
                            </td>
                        </tr>`;
                    }).join('') || '<tr><td colspan="8" class="p-4">Tiada sejarah dijumpai.</td></tr>';
                } catch(e) { tb.innerHTML = '<tr><td colspan="8">Gagal memuatkan sejarah.</td></tr>'; }
            },
            exportExcel: async () => {
                const today = Utils.getToday();
                const formatted = Loan.currentHistory.map(l => {
                    const isActiveLate = l.status === 'Active' && l.end_date < today;
                    const isReturnedLate = l.status === 'Returned' && l.return_date && (new Date(l.return_date).toISOString().split('T')[0] > l.end_date);
                    let lateStatus = '';
                    if(isActiveLate) lateStatus = '(LEWAT)';
                    if(isReturnedLate) lateStatus = '(PULANG LEWAT)';

                    return {
                        'Tarikh Pinjam': Utils.formatDate(l.created_at),
                        'Peminjam': l.user_name,
                        'Tag Aset': l.device_tag,
                        'Tempoh Pinjaman': `${l.start_date} - ${l.end_date} ${lateStatus}`,
                        'Pegawai Pengeluar': STATE.userMap[l.issued_by?.toLowerCase()] || l.issued_by,
                        'Pegawai Penerima': STATE.userMap[l.received_by?.toLowerCase()] || l.received_by || '-',
                        'Tarikh Pulang': l.return_date ? Utils.formatDate(l.return_date) : '-',
                        'Status': l.status
                    };
                });
                const ws = XLSX.utils.json_to_sheet(formatted);
                const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "HistoryPinjaman");
                XLSX.writeFile(wb, "Rekod_UTM_Pinjaman.xlsx");
            },
            checkOverdueLoans: async () => {
                try {
                    const { data } = await sbClient.from('rekod_pinjaman').select('*').eq('status','Active');
                    const overdue = data?.filter(l => l.end_date < Utils.getToday());
                    if (overdue?.length) {
                        document.getElementById('overdue-list-body').innerHTML = overdue.map(l => `<tr><td class="p-2 font-bold">${l.user_name}</td><td class="p-2">${l.device_tag}</td><td class="p-2 text-red-600 font-bold">${l.end_date}</td><td class="p-2 text-center"><button class="bg-orange-500 text-white px-2 py-1 rounded text-[9px] font-bold">SEND ALERT</button></td></tr>`).join('');
                        document.getElementById('overdue-modal').classList.remove('hidden');
                    } else Utils.showToast("Tiada rekod pinjaman lewat aktif.");
                } catch(e) { alert(e.message); }
            },
            addUser: async () => { 
                const n = document.getElementById('newUserName').value.trim(); 
                const e = document.getElementById('newUserEmail').value.trim();
                if(!n || !e) return alert("Sila isi Nama dan ID Email.");
                try {
                    const fullEmail = e.includes('@') ? e : e + '@moe.gov.my';
                    const { error } = await sbClient.from('user_ba').insert([{
                        id: crypto.randomUUID(),
                        created_at: new Date().toISOString(),
                        name: n.toUpperCase(), 
                        emel: fullEmail
                    }]); 
                    if(error) throw error;
                    Utils.showToast("Pengguna Berjaya Ditambah");
                    Loan.loadData(); 
                    document.getElementById('newUserName').value=''; 
                    document.getElementById('newUserEmail').value='';
                } catch(err) { alert("Gagal Simpan Pengguna: " + err.message); }
            },
            addDevice: async () => {
                const t = document.getElementById('newTag').value.trim(); 
                const tp = document.getElementById('newType').value.trim(); 
                const s = document.getElementById('newSerial').value.trim();
                if(!t) return alert("Sila masukkan Tag Aset.");
                try {
                    const { error } = await sbClient.from('device_inventory').insert([{
                        id: crypto.randomUUID(),
                        created_at: new Date().toISOString(),
                        tag: t, 
                        type: tp, 
                        serial: s, 
                        status: 'Tersedia'
                    }]); 
                    if(error) throw error;
                    Utils.showToast("Peranti Berjaya Didaftarkan");
                    Loan.loadData(); 
                    document.getElementById('newTag').value=''; 
                    document.getElementById('newType').value='';
                    document.getElementById('newSerial').value='';
                } catch(err) { alert("Gagal Simpan Peranti: " + err.message); }
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            if (typeof lucide !== 'undefined') lucide.createIcons();
            Auth.init();
            document.getElementById('login-form').addEventListener('submit', Auth.login);
            document.getElementById('global-search').addEventListener('input', (e) => CallLog.handleSearch(e.target.value));
            document.getElementById('data-form').addEventListener('submit', CallLog.submit);
        });
    </script>
</body>
</html>
