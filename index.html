<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Rekod Log & Pinjaman (Final)</title>
    
    <!-- LIBRARIES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- SheetJS for Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <!-- jsPDF and AutoTable for PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .hidden-section { display: none !important; }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%;
            width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #debug-console {
            background-color: #1a1a1a; color: #00ff00; font-family: monospace;
            padding: 1rem; margin-top: 2rem; border-radius: 0.5rem; font-size: 0.75rem;
            height: 150px; overflow-y: auto; border: 1px solid #333; width: 100%;
        }

        .table-container { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        table { width: 100%; min-width: 800px; border-collapse: collapse; }
        th, td { white-space: normal !important; padding: 0.75rem; vertical-align: top; }

        /* --- NETFLIX STYLE LOGIN ANIMATION --- */
        .login-btn-anim {
            position: relative;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        /* Loading State: Netflix Style "UTM" */
        .login-btn-anim.loading {
            background-color: #000000 !important; /* Netflix Black */
            color: transparent !important; /* Hide "Log Masuk" */
            pointer-events: none;
            border: 1px solid #1a1a1a;
        }
        
        .login-btn-anim.loading::after {
            content: "UTM";
            position: absolute;
            color: #E50914; /* Netflix Red */
            font-family: 'Arial Black', 'Arial', sans-serif;
            font-weight: 900;
            font-size: 1.8rem;
            letter-spacing: 2px;
            animation: netflix-zoom 2s ease-in-out infinite;
            text-shadow: 0 0 15px rgba(229, 9, 20, 0.8);
        }

        @keyframes netflix-zoom {
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.2); opacity: 1; text-shadow: 0 0 25px rgba(229, 9, 20, 1); }
            100% { transform: scale(1); opacity: 0.8; }
        }

        /* Success State: Green Checkmark */
        .login-btn-anim.success {
            width: 50px !important; /* Shrink to circle only on success */
            border-radius: 50px !important;
            background-color: #22c55e !important; /* Green-500 */
            color: transparent !important;
            pointer-events: none;
        }

        .login-btn-anim.success::after {
            content: ""; /* Remove UTM text */
            display: none;
        }

        .login-btn-anim.success::before {
            content: "";
            position: absolute;
            width: 15px;
            height: 24px;
            border-right: 4px solid white;
            border-bottom: 4px solid white;
            transform: rotate(45deg) translate(-2px, -2px);
            animation: checkmark 0.3s ease-in-out forwards;
        }

        @keyframes checkmark {
            0% { opacity: 0; transform: rotate(45deg) scale(0.5) translate(-2px, -2px); }
            100% { opacity: 1; transform: rotate(45deg) scale(1) translate(-2px, -2px); }
        }

        /* Active Tab Styles */
        .tab-active-main { background-color: #1e3a8a !important; /* blue-900 */ }
        .tab-inactive-main { background-color: transparent; }
        .tab-active-sub { color: #2563eb !important; border-bottom: 2px solid #2563eb !important; }
        .tab-inactive-sub { color: #6b7280; border-bottom: 2px solid transparent; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- LOGIN SCREEN -->
    <div id="login-page" class="min-h-screen flex flex-col items-center justify-center p-4">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-auto z-10 relative">
            <div class="text-center mb-8 mt-4">
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Sistem Rekod <br> Unit Teknologi Maklumat</h1>
                <p class="text-gray-500 text-sm mt-2">Sila log masuk untuk meneruskan</p>
            </div>
            
            <form id="login-form" class="space-y-6">
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Email</label>
                    <input type="email" id="email" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required placeholder="admin@example.com">
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                    <input type="password" id="password" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required placeholder="********">
                </div>
                <div id="login-error" class="text-red-500 text-sm hidden bg-red-100 p-3 rounded border border-red-200 whitespace-pre-line"></div>
                
                <div class="flex justify-center w-full h-[60px]"> <!-- Fixed height container for button -->
                    <button type="submit" id="login-btn" class="login-btn-anim w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 h-[50px]">
                        <span id="btn-text">Log Masuk</span>
                    </button>
                </div>
            </form>
            <div class="mt-4 text-center">
                 <button onclick="toggleSignUp()" class="text-sm text-blue-500 hover:underline">Tiada akaun? Daftar disini</button>
            </div>
        </div>
        <div id="debug-console" class="w-full max-w-md mt-4"><div>> Booting System...</div></div>
    </div>

    <!-- MAIN APP -->
    <div id="app-layout" class="hidden-section min-h-screen flex flex-col w-full">
        <nav class="bg-blue-800 text-white shadow-lg sticky top-0 z-50">
            <div class="w-full px-4 sm:px-6 lg:px-8"> 
                <div class="flex flex-col md:flex-row items-center justify-between h-auto md:h-16 py-2 md:py-0">
                    <div class="flex flex-col md:flex-row items-center w-full md:w-auto">
                        <span class="font-bold text-lg md:text-xl mb-2 md:mb-0 text-center md:text-left">Sistem Rekod<br>Unit Teknologi Maklumat</span>
                        <div class="md:ml-10 flex flex-wrap justify-center gap-2">
                            <!-- Main Tabs -->
                            <button onclick="switchMainTab('call-log')" class="px-4 md:px-6 py-2 text-sm md:text-base font-medium whitespace-nowrap tab-active-main" id="nav-call-log">Call Log</button>
                            <button onclick="switchMainTab('loan')" class="px-4 md:px-6 py-2 text-sm md:text-base font-medium whitespace-nowrap tab-inactive-main" id="nav-loan">Pinjaman ICT</button>
                        </div>
                    </div>
                    <div class="mt-2 md:mt-0 flex items-center justify-center w-full md:w-auto">
                        <span id="user-display" class="text-xs md:text-sm mr-4 text-blue-200 truncate max-w-[150px]"></span>
                        <button onclick="handleLogout()" class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-sm whitespace-nowrap">Keluar</button>
                    </div>
                </div>
            </div>
        </nav>

        <main class="flex-grow p-4 md:p-6 w-full mx-auto"> 
            
            <input type="file" id="excel-upload" accept=".xlsx, .xls, .csv" class="hidden" onchange="handleFileUpload(event)">
            <input type="file" id="master-data-upload" accept=".xlsx, .xls, .csv" class="hidden" onchange="handleMasterDataUpload(event)">
            <input type="file" id="loan-user-upload" accept=".xlsx, .xls, .csv" class="hidden" onchange="handleLoanUserUpload(event)">
            <input type="file" id="loan-inventory-upload" accept=".xlsx, .xls, .csv" class="hidden" onchange="handleLoanInventoryUpload(event)">
            <input type="file" id="loan-records-upload" accept=".xlsx, .xls, .csv" class="hidden" onchange="handleLoanRecordsUpload(event)">

            <!-- CALL LOG -->
            <div id="call-log-section" class="w-full">
                <div class="flex flex-wrap border-b mb-6 overflow-x-auto">
                    <!-- Call Log Sub Tabs -->
                    <button onclick="switchCallLogTab('search')" id="btn-sub-search" class="px-4 md:px-6 py-2 text-sm md:text-base font-medium whitespace-nowrap tab-active-sub">Carian & Input</button>
                    <button onclick="switchCallLogTab('records')" id="btn-sub-records" class="px-4 md:px-6 py-2 text-sm md:text-base font-medium whitespace-nowrap tab-inactive-sub hover:text-blue-600">Pangkalan Data Rekod</button>
                </div>

                <div id="sub-search-page" class="space-y-6 w-full">
                    <div class="bg-white p-4 md:p-6 rounded-lg shadow border border-gray-200">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                            <h2 class="text-lg font-semibold flex items-center gap-2"><i data-lucide="search"></i> Carian Live (Master Data)</h2>
                            <div class="flex flex-wrap gap-2 w-full md:w-auto">
                                <button onclick="triggerMasterUpload()" class="admin-only hidden bg-blue-100 text-blue-700 px-3 py-1.5 rounded-lg text-xs md:text-sm hover:bg-blue-200 transition flex items-center gap-2 border border-blue-200 flex-grow md:flex-grow-0 justify-center">
                                    <i data-lucide="database-backup" class="w-4 h-4"></i> Import Data Induk
                                </button>
                                <button onclick="confirmClearMasterDatabase()" class="admin-only hidden bg-red-100 text-red-700 px-3 py-1.5 rounded-lg text-xs md:text-sm hover:bg-red-200 transition flex items-center gap-2 border border-red-200 flex-grow md:flex-grow-0 justify-center">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i> Padam Data Induk
                                </button>
                            </div>
                        </div>
                        <div class="relative w-full">
                            <div class="flex flex-col md:flex-row gap-2">
                                <div class="relative"><label class="block text-sm font-medium text-gray-700 mb-1">IC</label><div class="relative"><input type="text" id="global-search" class="w-full px-10 py-2 border rounded-lg bg-gray-50 read-only:text-gray-500" readonly><button type="button" onclick="enableEdit('ic')" class="absolute right-2 top-2 text-gray-400 hover:text-blue-600"><i data-lucide="pencil" class="w-4 h-4"></i></button></div></div>
                                <button onclick="handleLiveSearch(document.getElementById('global-search').value)" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 w-full md:w-auto">Cari</button>
                            </div>
                            <div id="search-results-dropdown" class="absolute z-50 w-full bg-white shadow-xl rounded-b-lg border border-gray-100 hidden max-h-60 overflow-y-auto mt-1"></div>
                        </div>
                    </div>

                    <div class="bg-white p-4 md:p-6 rounded-lg shadow border border-gray-200">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-2">
                            <h2 class="text-lg font-semibold flex items-center gap-2"><i data-lucide="file-text"></i> Borang Maklumat</h2>
                            <span class="text-sm bg-blue-100 text-blue-800 px-3 py-1 rounded-full self-start md:self-auto" id="current-date"></span>
                        </div>
                        <form id="data-form" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="relative group"><label class="block text-sm font-medium text-gray-700 mb-1">IC</label><div class="relative"><input type="text" id="ic" class="w-full px-3 py-2 border rounded-lg bg-gray-50 read-only:text-gray-500" readonly><button type="button" onclick="enableEdit('ic')" class="absolute right-2 top-2 text-gray-400 hover:text-blue-600"><i data-lucide="pencil" class="w-4 h-4"></i></button></div></div>
                                <div class="relative"><label class="block text-sm font-medium text-gray-700 mb-1">Nama</label><div class="relative"><input type="text" id="nama" class="w-full px-3 py-2 border rounded-lg bg-gray-50 read-only:text-gray-500" readonly><button type="button" onclick="enableEdit('nama')" class="absolute right-2 top-2 text-gray-400 hover:text-blue-600"><i data-lucide="pencil" class="w-4 h-4"></i></button></div></div>
                                <div class="relative"><label class="block text-sm font-medium text-gray-700 mb-1">Telefon</label><div class="relative"><input type="text" id="telefon" class="w-full px-3 py-2 border rounded-lg bg-gray-50 read-only:text-gray-500" readonly><button type="button" onclick="enableEdit('telefon')" class="absolute right-2 top-2 text-gray-400 hover:text-blue-600"><i data-lucide="pencil" class="w-4 h-4"></i></button></div></div>
                                <div class="relative"><label class="block text-sm font-medium text-gray-700 mb-1">Emel</label><div class="relative"><input type="email" id="emel" class="w-full px-3 py-2 border rounded-lg bg-gray-50 read-only:text-gray-500" readonly><button type="button" onclick="enableEdit('emel')" class="absolute right-2 top-2 text-gray-400 hover:text-blue-600"><i data-lucide="pencil" class="w-4 h-4"></i></button></div></div>
                                <div class="relative"><label class="block text-sm font-medium text-gray-700 mb-1">Gred</label><div class="relative"><input type="text" id="gred" class="w-full px-3 py-2 border rounded-lg bg-gray-50 read-only:text-gray-500" readonly><button type="button" onclick="enableEdit('gred')" class="absolute right-2 top-2 text-gray-400 hover:text-blue-600"><i data-lucide="pencil" class="w-4 h-4"></i></button></div></div>
                                <div class="relative"><label class="block text-sm font-medium text-gray-700 mb-1">Kod PTJ</label><div class="relative"><input type="text" id="kod_ptj" class="w-full px-3 py-2 border rounded-lg bg-gray-50 read-only:text-gray-500" readonly><button type="button" onclick="enableEdit('kod_ptj')" class="absolute right-2 top-2 text-gray-400 hover:text-blue-600"><i data-lucide="pencil" class="w-4 h-4"></i></button></div></div>
                                <div class="relative md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-1">Jabatan</label><div class="relative"><input type="text" id="department" class="w-full px-3 py-2 border rounded-lg bg-gray-50 read-only:text-gray-500" readonly><button type="button" onclick="enableEdit('department')" class="absolute right-2 top-2 text-gray-400 hover:text-blue-600"><i data-lucide="pencil" class="w-4 h-4"></i></button></div></div>
                            </div>
                            <div class="mt-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
                                <label class="block text-sm font-bold text-gray-800 mb-3">Kategori Sistem & Isu <span class="text-red-500">*</span></label>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4" id="system-radio-group">
                                    <label class="flex items-center space-x-2 cursor-pointer bg-white p-2 rounded border hover:bg-blue-50"><input type="radio" name="system_type" value="ecp450" class="form-radio text-blue-600"><span class="text-xs font-medium">ECP450 / Portal</span></label>
                                    <label class="flex items-center space-x-2 cursor-pointer bg-white p-2 rounded border hover:bg-blue-50"><input type="radio" name="system_type" value="ecp400" class="form-radio text-blue-600"><span class="text-xs font-medium">ECP400</span></label>
                                    <label class="flex items-center space-x-2 cursor-pointer bg-white p-2 rounded border hover:bg-blue-50"><input type="radio" name="system_type" value="hcp400" class="form-radio text-blue-600"><span class="text-xs font-medium">HCP400</span></label>
                                    <label class="flex items-center space-x-2 cursor-pointer bg-white p-2 rounded border hover:bg-blue-50"><input type="radio" name="system_type" value="psa400" class="form-radio text-blue-600"><span class="text-xs font-medium">PSA400 / SOLMAN</span></label>
                                    <label class="flex items-center space-x-2 cursor-pointer bg-white p-2 rounded border hover:bg-blue-50"><input type="radio" name="system_type" value="bp1" class="form-radio text-blue-600"><span class="text-xs font-medium">BP1</span></label>
                                    <label class="flex items-center space-x-2 cursor-pointer bg-white p-2 rounded border hover:bg-blue-50"><input type="radio" name="system_type" value="bwp" class="form-radio text-blue-600"><span class="text-xs font-medium">BWP</span></label>
                                    <label class="flex items-center space-x-2 cursor-pointer bg-white p-2 rounded border hover:bg-blue-50"><input type="radio" name="system_type" value="mycost" class="form-radio text-blue-600"><span class="text-xs font-medium">MyCost</span></label>
                                </div>
                                <div id="issue-dropdown-container" class="hidden animate-fade-in">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Isu <span class="text-red-500">*</span></label>
                                    <select id="issue-dropdown" class="w-full px-3 py-2 border rounded-lg bg-white focus:ring-2 focus:ring-blue-500 outline-none"><option value="" disabled selected>Sila Pilih Isu</option></select>
                                </div>
                                <div id="other-issue-container" class="mt-3 hidden animate-fade-in">
                                    <input type="text" id="other-issue-input" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Sila nyatakan masalah lain secara spesifik...">
                                </div>
                            </div>
                            <div class="pt-4 border-t border-gray-100 flex justify-end">
                                <button type="submit" id="submit-btn" disabled class="w-full md:w-auto bg-green-600 text-white font-bold py-2 px-8 rounded-lg hover:bg-green-700 transition transform hover:scale-105 flex items-center justify-center gap-2 opacity-50 cursor-not-allowed"><i data-lucide="save"></i> Hantar & Simpan</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div id="sub-records-page" class="hidden-section space-y-6 w-full">
                    <div class="bg-white p-4 md:p-6 rounded-lg shadow border border-gray-200">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                            <h2 class="text-xl font-bold flex items-center gap-2 text-gray-800 text-center md:text-left"><i data-lucide="database"></i> Rekod Panggilan dan Emel IGFMAS</h2>
                            <div class="flex flex-wrap gap-2 items-center justify-center">
                                <button onclick="triggerImport()" class="admin-only hidden bg-gray-700 text-white px-3 py-2 rounded-lg text-xs md:text-sm hover:bg-gray-800"><i data-lucide="upload"></i> Import</button>
                                <button onclick="exportToExcel()" class="bg-green-600 text-white px-3 py-2 rounded-lg text-xs md:text-sm hover:bg-green-700 flex items-center gap-2"><i data-lucide="sheet"></i> Excel</button>
                                <button onclick="exportToPDF()" class="bg-red-600 text-white px-3 py-2 rounded-lg text-xs md:text-sm hover:bg-red-700 flex items-center gap-2"><i data-lucide="file-down"></i> PDF</button>
                                <button onclick="fetchRecords()" class="bg-gray-100 text-gray-700 px-3 py-2 rounded-lg hover:bg-gray-200"><i data-lucide="refresh-cw"></i></button>
                                <button onclick="confirmClearDatabase()" class="admin-only hidden bg-red-100 text-red-700 border border-red-200 px-3 py-2 rounded-lg text-xs md:text-sm hover:bg-red-200 flex items-center gap-2"><i data-lucide="trash-2"></i> Kosongkan</button>
                            </div>
                        </div>
                        <div class="table-container border border-gray-200 rounded-lg">
                            <table class="min-w-full bg-white text-xs md:text-sm" id="records-table">
                                <thead class="bg-gray-100 text-gray-700 uppercase leading-normal">
                                    <tr>
                                        <th class="text-left w-32">Tarikh Masa</th>
                                        <th class="text-left w-32">IC</th>
                                        <th class="text-left w-40">Nama</th>
                                        <th class="text-left w-32">Jabatan</th>
                                        <th class="text-left">Perkara</th>
                                        <th class="text-left w-32">Direkod Oleh</th>
                                        <th class="text-left w-24">Status</th>
                                        <th class="text-left w-32">Tarikh Kemaskini</th>
                                        <th class="text-left w-32">Dikemaskini Oleh</th>
                                    </tr>
                                </thead>
                                <tbody class="text-gray-600 font-light" id="table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PINJAMAN ICT -->
            <div id="loan-page" class="hidden-section space-y-6 w-full">
                <div class="bg-white p-4 md:p-6 rounded-lg shadow border border-gray-200">
                    <h2 class="text-xl font-bold flex items-center gap-2 text-gray-800 mb-6"><i data-lucide="monitor-smartphone"></i> Sistem Pinjaman Peranti</h2>
                    <div class="flex flex-wrap border-b mb-6 overflow-x-auto">
                        <!-- Loan Sub Tabs -->
                        <button onclick="switchLoanTab('loan-tab-borrow')" id="btn-loan-borrow" class="px-4 md:px-6 py-2 text-sm md:text-base font-medium whitespace-nowrap tab-active-sub">Pinjam</button>
                        <button onclick="switchLoanTab('loan-tab-return')" id="btn-loan-return" class="px-4 md:px-6 py-2 text-sm md:text-base font-medium whitespace-nowrap tab-inactive-sub hover:text-blue-600">Pulang</button>
                        <button onclick="switchLoanTab('loan-tab-admin')" id="btn-loan-admin" class="px-4 md:px-6 py-2 text-sm md:text-base font-medium whitespace-nowrap tab-inactive-sub hover:text-blue-600">Admin</button>
                        <button onclick="switchLoanTab('loan-tab-history')" id="btn-loan-history" class="px-4 md:px-6 py-2 text-sm md:text-base font-medium whitespace-nowrap tab-inactive-sub hover:text-blue-600">Rekod Pinjaman</button>
                    </div>

                    <div id="loan-tab-borrow" class="loan-tab-content">
                        <form id="loanForm" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="block text-sm font-medium text-gray-700 mb-1">Nama Pengguna</label><input type="text" id="loanUserName" list="userList" class="w-full px-3 py-2 border rounded-lg" required><datalist id="userList"></datalist></div>
                                <div><label class="block text-sm font-medium text-gray-700 mb-1">Pilih Peranti</label><select id="deviceSelect" class="w-full px-3 py-2 border rounded-lg" required><option value="" disabled selected>Pilih...</option></select></div>
                                <div><label class="block text-sm font-medium text-gray-700 mb-1">Mula</label><input type="date" id="loanStartDate" class="w-full px-3 py-2 border rounded-lg" required></div>
                                <div><label class="block text-sm font-medium text-gray-700 mb-1">Tamat</label><input type="date" id="loanEndDate" class="w-full px-3 py-2 border rounded-lg" required></div>
                            </div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-1">Jenis Kegunaan</label><select id="usageType" class="w-full px-3 py-2 border rounded-lg" required><option value="Kegunaan Dalaman">Kegunaan Dalaman</option><option value="Kegunaan Luar">Kegunaan Luar</option></select></div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-1">Butiran</label><textarea id="usageDetails" rows="2" class="w-full px-3 py-2 border rounded-lg"></textarea></div>
                            <button type="button" onclick="submitLoan()" class="w-full bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700 transition">Hantar</button>
                        </form>
                    </div>

                    <div id="loan-tab-return" class="loan-tab-content hidden">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 text-center">
                            <h5 class="text-lg font-bold text-blue-800 mb-2">Pulangkan Peranti</h5>
                            <select id="returnSelect" class="w-full max-w-md mx-auto px-3 py-2 border rounded-lg mb-4"><option value="" disabled selected>Pilih Peranti...</option></select>
                            <button type="button" onclick="submitReturn()" class="bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition w-full md:w-auto">Sahkan Pulangan</button>
                        </div>
                    </div>

                    <!-- ADMIN TAB -->
                    <div id="loan-tab-admin" class="loan-tab-content hidden">
                        <div class="mb-8 p-4 border rounded-lg bg-yellow-50 border-yellow-200">
                            <h6 class="font-bold text-yellow-800 mb-3 flex items-center gap-2"><i data-lucide="upload-cloud"></i> Bulk Import & Data Management</h6>
                            <div class="flex flex-wrap gap-3">
                                <div class="admin-only hidden flex items-center gap-1 border-r border-yellow-300 pr-3 mr-2">
                                    <button onclick="triggerLoanUpload('user')" class="bg-yellow-600 text-white px-4 py-2 rounded-l text-sm hover:bg-yellow-700 flex items-center gap-2"><i data-lucide="users"></i> Upload Users</button>
                                    <button onclick="confirmClearUserDatabase()" class="bg-red-500 text-white px-3 py-2 rounded-r text-sm hover:bg-red-600 flex items-center gap-2" title="Padam semua"><i data-lucide="trash-2"></i> Clear</button>
                                </div>
                                <button onclick="checkOverdueLoans()" class="bg-orange-600 text-white px-4 py-2 rounded text-sm hover:bg-orange-700 flex items-center gap-2"><i data-lucide="bell-ring"></i> Semak Lewat & Hantar Emel</button>
                                <button onclick="triggerLoanUpload('inventory')" class="admin-only hidden bg-yellow-600 text-white px-4 py-2 rounded text-sm hover:bg-yellow-700 flex items-center gap-2"><i data-lucide="monitor"></i> Upload Inventory</button>
                                <button onclick="triggerLoanUpload('records')" class="admin-only hidden bg-yellow-600 text-white px-4 py-2 rounded text-sm hover:bg-yellow-700 flex items-center gap-2"><i data-lucide="file-clock"></i> Upload History</button>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">
                            <div class="space-y-6">
                                <div class="border p-4 rounded-lg bg-gray-50 shadow-sm">
                                    <h6 class="font-bold mb-3 text-gray-700 border-b pb-2">Tambah Pengguna Baru</h6>
                                    <input id="newUserName" class="w-full px-3 py-2 border rounded-lg mb-2" placeholder="Nama Penuh">
                                    <input id="newUserEmail" class="w-full px-3 py-2 border rounded-lg mb-2" placeholder="Alamat Emel">
                                    <button onclick="addUser()" class="w-full bg-gray-700 text-white py-2 rounded-lg hover:bg-gray-800 transition">Tambah</button>
                                </div>
                                <div class="border p-4 rounded-lg bg-gray-50 shadow-sm"><h6 class="font-bold mb-3 text-gray-700 border-b pb-2">Tambah Peranti Baru</h6><input id="newTag" class="w-full px-3 py-2 border rounded-lg mb-2" placeholder="Tag Aset"><select id="newType" class="w-full px-3 py-2 border rounded-lg mb-2"><option>Notebook</option><option>Projector</option><option>HDMI Cable</option><option>Webcam</option></select><input id="newSerial" class="w-full px-3 py-2 border rounded-lg mb-2" placeholder="No. Siri"><button onclick="addDevice()" class="w-full bg-gray-700 text-white py-2 rounded-lg hover:bg-gray-800 transition">Tambah</button></div>
                            </div>
                            <div class="border p-4 rounded-lg bg-white shadow-sm h-full"><h6 class="font-bold mb-3 text-gray-700 border-b pb-2">Senarai Pinjaman Aktif</h6><div class="table-container"><table class="min-w-full text-sm"><thead class="bg-gray-100 sticky top-0"><tr><th class="p-2 text-left">Peminjam</th><th class="p-2 text-left">Peranti</th><th class="p-2 text-left">Tamat</th></tr></thead><tbody id="active-loans-body"></tbody></table></div></div>
                        </div>
                    </div>

                    <div id="loan-tab-history" class="loan-tab-content hidden">
                        <div class="mb-4 flex justify-between items-center"><h6 class="font-bold text-gray-700">Sejarah Pinjaman</h6><div class="flex gap-2"><button onclick="exportLoanHistoryToExcel()" class="bg-green-600 text-white px-3 py-1.5 rounded text-xs hover:bg-green-700"><i data-lucide="sheet" class="w-3 h-3"></i> Excel</button><button onclick="exportLoanHistoryToPDF()" class="bg-red-600 text-white px-3 py-1.5 rounded text-xs hover:bg-red-700"><i data-lucide="file-down" class="w-3 h-3"></i> PDF</button><button onclick="loadLoanHistory()" class="bg-gray-200 px-3 py-1.5 rounded hover:bg-gray-300 text-xs"><i data-lucide="refresh-cw" class="w-3 h-3"></i> Refresh</button></div></div>
                        <div class="table-container border border-gray-200 rounded-lg">
                            <table class="min-w-full text-sm">
                                <thead class="bg-gray-100 text-gray-700">
                                    <tr>
                                        <th class="p-3 text-left w-24">Tarikh Mohon</th>
                                        <th class="p-3 text-left w-32">Peminjam</th>
                                        <th class="p-3 text-left w-24">Peranti</th>
                                        <th class="p-3 text-left w-32">Tempoh</th>
                                        <th class="p-3 text-left w-24">Dikeluarkan Oleh</th>
                                        <th class="p-3 text-left w-24">Pulang</th>
                                        <th class="p-3 text-left w-24">Diterima Oleh</th>
                                        <th class="p-3 text-left w-20">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="loan-history-body" class="bg-white"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODALS -->
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white px-6 py-3 rounded shadow-lg transform translate-y-20 transition duration-300 opacity-0 z-50"></div>

    <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 px-4">
        <div class="bg-white p-8 rounded-lg shadow-2xl max-w-sm w-full text-center border-t-4 border-red-600">
            <h3 class="text-lg font-bold text-gray-900 mb-2" id="modal-title">Amaran</h3>
            <p class="text-sm text-gray-500 mb-6" id="modal-message">Pasti padam semua?</p>
            <div class="flex justify-center gap-4"><button onclick="closeDeleteModal()" class="px-4 py-2 bg-gray-200 rounded">Batal</button><button onclick="executeClearDatabase()" class="px-4 py-2 bg-red-600 text-white font-bold rounded">PADAM</button></div>
        </div>
    </div>

    <div id="overdue-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 px-4">
        <div class="bg-white rounded-lg shadow-2xl max-w-3xl w-full max-h-[80vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center bg-orange-50"><h3 class="text-lg font-bold text-orange-800">Senarai Lewat</h3><button onclick="document.getElementById('overdue-modal').classList.add('hidden')">X</button></div>
            <div class="p-4 overflow-y-auto flex-grow">
                <table class="w-full text-sm text-left"><thead class="bg-gray-100"><tr><th class="p-2">Nama</th><th class="p-2">Emel</th><th class="p-2">Peranti</th><th class="p-2">Tamat</th><th class="p-2 text-center">Tindakan</th></tr></thead><tbody id="overdue-list-body"></tbody></table>
                <div id="no-overdue-msg" class="hidden text-center py-8 text-gray-500">Tiada lewat.</div>
            </div>
        </div>
    </div>

    <!-- SCRIPT -->
    <script>
        const supabaseUrl = 'https://objxfgosatmasjjifkkg.supabase.co'; 
        const supabaseAnonKey = 'sb_publishable_UJ86SYk1Kk5nBVnpjNXcpA_NSiZzsAO';

        function logDebug(msg, isError=false) {
            const c = document.getElementById('debug-console'); if(!c) return;
            const d = document.createElement('div'); d.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            if(isError) d.style.color = '#ff4444'; c.appendChild(d); c.scrollTop = c.scrollHeight;
        }

        async function withTimeout(promise, ms=15000) {
            return Promise.race([promise, new Promise((_,r) => setTimeout(() => r(new Error("Timeout")), ms))]);
        }

        // --- SAFETY INIT ---
        let supabase = null, currentUser = null;
        try {
            if (!window.supabase) throw new Error("Supabase Library Gagal Dimuatkan (Firewall?).");
            supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
            logDebug("Supabase Init OK.");
        } catch (e) {
            setTimeout(()=>logDebug("CRITICAL: "+e.message, true), 500);
            alert("Ralat Init: " + e.message);
        }

        let currentRecords = [], currentLoanHistory = [], clearActionType = '';
        let cachedUserMap = {}; // Global cache for user mapping

        // --- GLOBAL HELPER: RESOLVE NAME ---
        const resolveName = (val) => {
            if(!val) return '-';
            // 1. Check map
            if(cachedUserMap[val.toLowerCase()]) return cachedUserMap[val.toLowerCase()];
            // 2. Fallback: Format email if it looks like one
            if(val.includes('@')) {
                // "ali.abu@moe.gov.my" -> "Ali Abu"
                return val.split('@')[0].replace(/[._]/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
            }
            // 3. Last resort: Return raw value (e.g. UUID)
            return val;
        };

        document.addEventListener('DOMContentLoaded', () => {
            if(typeof lucide !== 'undefined') lucide.createIcons();
            if(supabase) checkAuth();            
            // Listeners
            document.getElementById('global-search').addEventListener('input', (e) => handleLiveSearch(e.target.value));
            document.querySelectorAll('input, select, textarea').forEach(i => i.addEventListener('input', checkFormValidity));
            document.querySelectorAll('input[name="system_type"]').forEach(r => r.addEventListener('change', () => { updateDropdown(r.value); checkFormValidity(); }));
            document.getElementById('issue-dropdown').addEventListener('change', (e) => {
                document.getElementById('other-issue-container').classList.toggle('hidden', e.target.value !== 'Lain-lain');
                checkFormValidity();
            });
            checkFormValidity();

        });

        // --- AUTH ---
        async function checkAuth() {
            try {
                const { data: { session }, error } = await withTimeout(supabase.auth.getSession(), 5000);
                if(session) { currentUser = session.user; showApp(); } else showLogin();
            } catch(e) { logDebug("Auth Check Error: " + e.message, true); showLogin(); }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('email').value, password = document.getElementById('password').value;
            const btn = document.getElementById('login-btn'); 
            
            // Start Animation
            btn.classList.add('loading');
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                if(error) throw error;
                
                // Show Success State
                setTimeout(() => {
                    btn.classList.remove('loading');
                    btn.classList.add('success');
                    
                    // Trigger Page Transition after success
                    setTimeout(() => { 
                        currentUser = data.user; 
                        showApp(); 
                        // Reset button state for next logout/login
                        btn.classList.remove('success');
                    }, 2000);
                }, 1000); // Fake load time for visual

            } catch(e) {
                // Reset Button on Error
                btn.classList.remove('loading');
                document.getElementById('login-error').innerText = "Login Failed: " + e.message;
                document.getElementById('login-error').classList.remove('hidden');
            }
        }

        async function handleLogout() { await supabase.auth.signOut(); window.location.reload(); }
        async function toggleSignUp() {
            const e = document.getElementById('email').value, p = document.getElementById('password').value;
            if(!e || !p) return alert("Isi email & password.");
            const { error } = await supabase.auth.signUp({email:e, password:p});
            alert(error ? error.message : "Daftar berjaya. Sila login.");
        }

        document.getElementById('login-form').addEventListener('submit', handleLogin);

        function showLogin() { document.getElementById('login-page').classList.remove('hidden-section'); document.getElementById('app-layout').classList.add('hidden-section'); }
        function showApp() { 
            document.getElementById('login-page').classList.add('hidden-section'); document.getElementById('app-layout').classList.remove('hidden-section'); 
            document.getElementById('user-display').innerText = currentUser.email; 
            switchMainTab('call-log');
            checkAdminAccess(); // Trigger admin check on load
        }

        function checkAdminAccess() {
            const allowedAdmin = 'suhardi.alias@moe.gov.my';
            const isAdmin = currentUser && currentUser.email === allowedAdmin;

            document.querySelectorAll('.admin-only').forEach(el => {
                if (isAdmin) {
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            });
        }

        // --- NAV & TABS ---
        function switchMainTab(id) {
            document.getElementById('call-log-section').classList.toggle('hidden-section', id!=='call-log');
            document.getElementById('loan-page').classList.toggle('hidden-section', id!=='loan');
            
            // Highlight Logic
            const btn1 = document.getElementById('nav-call-log');
            const btn2 = document.getElementById('nav-loan');
            if(id === 'call-log') {
                btn1.classList.replace('tab-inactive-main', 'tab-active-main');
                btn2.classList.replace('tab-active-main', 'tab-inactive-main');
                switchCallLogTab('search');
            } else {
                btn2.classList.replace('tab-inactive-main', 'tab-active-main');
                btn1.classList.replace('tab-active-main', 'tab-inactive-main');
                switchLoanTab('loan-tab-borrow'); 
                loadLoanData();
            }
        }

        function switchCallLogTab(id) {
            document.getElementById('sub-search-page').classList.toggle('hidden-section', id!=='search');
            document.getElementById('sub-records-page').classList.toggle('hidden-section', id!=='records');
            
            const btnSearch = document.getElementById('btn-sub-search');
            const btnRec = document.getElementById('btn-sub-records');
            
            if(id === 'search') {
                btnSearch.classList.add('tab-active-sub'); btnSearch.classList.remove('tab-inactive-sub', 'hover:text-blue-600');
                btnRec.classList.add('tab-inactive-sub', 'hover:text-blue-600'); btnRec.classList.remove('tab-active-sub');
            } else {
                btnRec.classList.add('tab-active-sub'); btnRec.classList.remove('tab-inactive-sub', 'hover:text-blue-600');
                btnSearch.classList.add('tab-inactive-sub', 'hover:text-blue-600'); btnSearch.classList.remove('tab-active-sub');
                fetchRecords();
            }
        }

        function switchLoanTab(id) {
            document.querySelectorAll('.loan-tab-content').forEach(e => e.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            
            // Tab Group Logic
            ['btn-loan-borrow', 'btn-loan-return', 'btn-loan-admin', 'btn-loan-history'].forEach(btnId => {
                const btn = document.getElementById(btnId);
                const isSelected = btnId === ('btn-' + id);
                if(isSelected) {
                    btn.classList.add('tab-active-sub');
                    btn.classList.remove('tab-inactive-sub', 'hover:text-blue-600');
                } else {
                    btn.classList.add('tab-inactive-sub', 'hover:text-blue-600');
                    btn.classList.remove('tab-active-sub');
                }
            });

            if(id==='loan-tab-history') loadLoanHistory();
        }

        // --- LOGIC ---
        let searchTimeout = null;
        function handleLiveSearch(q) {
            const dd = document.getElementById('search-results-dropdown');
            if(searchTimeout) clearTimeout(searchTimeout);
            if(!q || q.length < 2) { dd.classList.add('hidden'); return; }
            searchTimeout = setTimeout(async () => {
                dd.classList.remove('hidden'); dd.innerHTML = '<div class="p-3 text-center">Searching...</div>';
                
                // UPDATED QUERY: Now searches nama, ic_number, kod_ptj, and department
                const { data } = await supabase.from('personnel').select('*')
                    .or(`nama.ilike.%${q}%,ic_number.ilike.%${q}%,kod_ptj.ilike.%${q}%,department.ilike.%${q}%`)
                    .limit(5);

                if(!data || !data.length) { 
                    // If no match is found, show a "Add New User" option
                    handleAddNewUser(q);
                } else {
                    // Show search results
                    dd.innerHTML = '';
                    data.forEach(p => {
                        const d = document.createElement('div'); d.className = 'p-3 hover:bg-blue-50 cursor-pointer border-b';
                        // Enhanced display to show Dept/PTJ in dropdown so user knows what they found
                        d.innerHTML = `
                            <div class="font-bold text-sm">${p.nama}</div>
                            <div class="flex justify-between items-center mt-1">
                                <div class="text-xs text-gray-500">${p.ic_number}</div>
                                <div class="text-xs text-blue-600 font-semibold">${p.kod_ptj || ''}</div>
                            </div>
                            <div class="text-xs text-gray-400 truncate">${p.department || ''}</div>
                        `;
                        d.onclick = () => {
                            ['ic','nama','telefon','emel','gred','kod_ptj','department'].forEach(k => document.getElementById(k).value = p[k==='ic'?'ic_number':k]||'');
                            dd.classList.add('hidden'); checkFormValidity();
                        };
                        dd.appendChild(d);
                    });
                }
            }, 300);
        }

        function handleAddNewUser(q) {
            const e = document.getElementById('email').value;
            if (!e || !q) return alert("Isi email dan nama pengguna.");

            const { error } = await supabase.from('personnel').insert({ nama: q, email: e });
            
            if (error) throw error;

            alert("Berjaya! Pengguna baru ditambah.");
            resetSearchResults(); // Reset search results to show user successfully added
        }

        function enableEditEmail(i) {
            const el = document.getElementById('email');
            if (!el.readOnly && !i.readOnly) return; // Skip if already editable
            el.classList.add('border-blue-400'); // Highlight for feedback
        }

        function enableEdit(i) {
            const el = document.getElementById(i.id);
            if (!el.readOnly && !i.readOnly) return; // Skip if already editable
            el.classList.add('border-blue-400'); // Highlight for feedback
            i.readOnly = false;
            
            // Add a submit button to save changes
            const btnSave = document.createElement('button');
            btnSave.className = 'bg-blue-500 text-white px-2 py-1 rounded absolute right-0 top-0 mr-2 mb-2';
            btnSave.type = 'button';
            btnSave.textContent = 'Hantar';
            btnSave.onclick = function() {
                const changes = {};
                
                // Check for changes
                ['ic','nama','telefon','emel','gred','kod_ptj','department'].forEach(k => {
                    changes[k] = document.getElementById(k).value;
                });

                if (Object.keys(changes).length === 0) {
                    btnSave.parentElement.removeChild(btnSave); // Remove button if no changes
                    return;
                }

                const { error } = await supabase.from('personnel').update(changes).eq('ic_number', document.getElementById('ic').value);

                if (error) {
                    alert(`Ralat Hantar: ${error.message}`);
                    btnSave.parentElement.removeChild(btnSave); // Remove button on error
                } else {
                    btnSave.parentElement.removeChild(btnSave); // Remove button on success
                    alert("Perubahan disimpan!");
                    checkFormValidity(); // Refresh form validation
                }
            };

            i.parentElement.appendChild(btnSave);
        }

        function resetSearchResults() {
            const dd = document.getElementById('search-results-dropdown');
            if(dd) dd.innerHTML = '';
        }

        // --- SUBMIT ---
        document.getElementById('data-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Safety Auth Check
            if (!currentUser) {
                await checkAuth(); // Try to refresh auth if missing
                if(!currentUser) return alert("Sila login semula.");
            }

            try {
                const sysRadio = document.querySelector('input[name="system_type"]:checked');
                if (!sysRadio) return alert("Sila pilih Kategori Sistem.");
                
                const sys = sysRadio.value;
                const iss = document.getElementById('issue-dropdown').value;
                if (!iss) return alert("Sila pilih Jenis Isu.");

                const oth = document.getElementById('other-issue-input').value;
                const note = `${sys} - ${iss}${iss==='Lain-lain' ? ' ('+oth+')' : ''}`;
                
                const row = {
                    ic_number: document.getElementById('ic').value, 
                    nama: document.getElementById('nama').value,
                    telefon: document.getElementById('telefon').value, 
                    emel: document.getElementById('emel').value,
                    gred: document.getElementById('gred').value, 
                    kod_ptj: document.getElementById('kod_ptj').value,
                    department: document.getElementById('department').value, 
                    confirmation: 'TIDAK', 
                    notes: note,
                    submitted_by: currentUser.id, 
                    perekod: currentUser.email
                };
                
                let { error } = await supabase.from('rekod').insert([row]);

                // EXPLICIT ERROR HANDLING FOR MISSING COLUMNS
                if (error && error.message && error.message.toLowerCase().includes("column")) {
                    alert("RALAT: Kolum 'submitted_by' tidak wujud dalam database. Sila tambah kolum 'submitted_by' (text) dalam table 'rekod' di Supabase untuk merekod nama admin.");
                    
                    // Fallback: Just update status without tracking info
                    logDebug("Retrying without 'submitted_by' column...", true);
                    const safeRow = { ...row }; delete safeRow.submitted_by;
                    const retry = await supabase.from('rekod').insert([safeRow]);
                    error = retry.error;
                }

                if(!error) { 
                    showToast("Disimpan!"); 
                    document.getElementById('data-form').reset(); 
                    // Reset manual UI states if needed
                    document.getElementById('issue-dropdown-container').classList.add('hidden');
                    document.getElementById('other-issue-container').classList.add('hidden');
                    checkFormValidity();

                } else {
                    alert("Ralat Simpan: " + error.message);
                }
            } catch(e) {
                console.error(e);
                alert("Ralat Hantar: " + e.message);
            }
        });

        // --- FETCH RECORDS & UPDATE STATUS ---
        async function fetchRecords() {
            const tb = document.getElementById('table-body');
            tb.innerHTML = '<tr><td colspan="9" class="text-center"><div class="loader"></div></td></tr>';

            try {
                // Fetch both records and user directory (Parallel for speed)
                const [ { data: records, error: err1 }, { data: users, error: err2 } ] = await Promise.all([
                    supabase.from('rekod').select('*').order('created_at', { ascending: false }),
                    supabase.from('user_ba').select('name, emel')
                ]);

                if(err1) throw err1;

                // Build User Map for Quick Lookup
                cachedUserMap = {};
                if(users) {
                    users.forEach(u => {
                        if(u.emel) cachedUserMap[u.emel.toLowerCase()] = u.name;
                    });
                }

                currentRecords = records || [];
                tb.innerHTML = '';

                if(!records || !records.length) {
                    tb.innerHTML = '<tr><td colspan="9" class="text-center">Tiada rekod.</td></tr>';
                    return;
                }

                records.forEach(r => {
                    const statusClass = r.confirmation === 'YA' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                    const updatedDate = r.status_updated_at ? new Date(r.status_updated_at).toLocaleString('ms-MY') : '-';
                    
                    const recName = resolveName(r.perekod);
                    const updName = resolveName(r.status_updated_by);

                    tb.innerHTML += `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="p-3">${new Date(r.created_at).toLocaleString()}</td>
                            <td class="p-3 font-medium">${r.ic_number}</td>
                            <td class="p-3">${r.nama}</td>
                            <td class="p-3">${r.department}</td>
                            <td class="p-3 text-sm text-gray-500">${r.notes}</td>
                            <td class="p-3 text-xs font-semibold text-blue-700">${recName}</td>
                            <td class="p-3">
                                <select onchange="updateRecordStatus('${r.id}', this.value)" class="border rounded p-1 text-xs font-bold cursor-pointer outline-none ${statusClass}">
                                    <option value="YA" ${r.confirmation === 'YA' ? 'selected' : ''}>YA</option>
                                    <option value="TIDAK" ${r.confirmation === 'TIDAK' ? 'selected' : ''}>TIDAK</option>
                                </select>
                            </td>
                            <td class="p-3 text-xs">${updatedDate}</td>
                            <td class="p-3 text-xs text-gray-500">${updName}</td>
                        </tr>`;
                });
            } catch(e) {
                console.error(e);
                tb.innerHTML = `<tr><td colspan="9" class="text-center text-red-500">Ralat Memuatkan Data: ${e.message}</td></tr>`;
            }
        }

        async function updateRecordStatus(id, newValue) {
            if(!currentUser) return alert("Sila login semula.");

            // Prepare Update Payload
            const updatePayload = {
                confirmation: newValue,
                status_updated_at: new Date(),
                status_updated_by: currentUser.email
            };

            let { error } = await supabase.from('rekod').update(updatePayload).eq('id', id);

            // ERROR HANDLING IF COLUMNS MISSING
            if (error && error.message && error.message.toLowerCase().includes("column")) {
                alert("WALANG: Status updated, but tracking failed. Please add columns 'status_updated_at' (timestamp) and 'status_updated_by' (text) to 'rekod' table.");
                
                // Fallback: Just update status without tracking info
                logDebug("Retrying without 'status_updated_by' column...", true);
                const safePayload = { ...updatePayload }; delete safePayload.status_updated_by;
                const retry = await supabase.from('rekod').update(safePayload).eq('id', id);
                error = retry.error;
            }

            if(error) return alert("Ralat Update: " + error.message);

            await fetchRecords(); 
        }

        // --- LOAN ---
        async function loadLoanData() {
            const { data: u } = await supabase.from('user_ba').select('name, emel').order('name');
            const ul = document.getElementById('userList'); ul.innerHTML = '';
            if(u) u.forEach(i => { const o = document.createElement('option'); o.value=i.name; ul.appendChild(o); });

            const { data: d } = await supabase.from('device_inventory').select('*').eq('status','Tersedia').order('tag');
            const ds = document.getElementById('deviceSelect'); ds.innerHTML = '<option value="" disabled selected>Pilih...</option>';
            if(d) d.forEach(i => { const o = document.createElement('option'); o.value=i.tag; o.text=`${i.tag} - ${i.type}`; ds.appendChild(o); });

            const { data: r } = await supabase.from('device_inventory').select('*').eq('status','Dipinjam').order('tag');
            const rs = document.getElementById('returnSelect'); rs.innerHTML = '<option value="" disabled selected>Pilih...</option>';
            if(r) r.forEach(i => { const o = document.createElement('option'); o.value=i.tag; o.text=`${i.tag} - ${i.type}`; rs.appendChild(o); });

            const { data: a } = await supabase.from('rekod_pinjaman').select('*').eq('status','Active').order('created_at',{ascending:false});
            const at = document.getElementById('active-loans-body'); at.innerHTML = '';
            
            // --- UPDATED: Check for overdue items ---
            const today = new Date(); today.setHours(0,0,0,0);

            if(a) a.forEach(l => {
                const endDate = new Date(l.end_date);
                const isOverdue = l.status === 'Active' && endDate < today;
                const overdueClass = isOverdue ? 'text-red-600 font-bold bg-red-50' : 'hover:bg-gray-50';

                at.innerHTML += `
                <tr class="border-b ${overdueClass}">
                    <td class="p-2">${l.user_name}</td>
                    <td class="p-2 text-blue-600">${l.device_tag}</td>
                    <td class="p-2">${l.end_date}</td>
                </tr>`;
            });
        }

        async function submitLoan() {
            try {
                const u = document.getElementById('loanUserName').value;
                const d = document.getElementById('deviceSelect').value;
                const s = document.getElementById('loanStartDate').value;
                const e = document.getElementById('loanEndDate').value;
                const t = document.getElementById('usageType').value;
                
                if(!u || !d || !s || !e) return alert("Sila isi semua.");
                
                // --- NEW LOGIC START ---
                // Validate that Start Date is not after End Date
                if (new Date(s) > new Date(e)) {
                    return alert("Ralat: Tarikh Mula tidak boleh selepas Tarikh Tamat.");
                }
                // --- NEW LOGIC END ---

                // Get Issuer (Ensure we have a valid user)
                if (!currentUser) {
                    await checkAuth(); // Try to refresh auth if missing
                    if(!currentUser) return alert("Sila login semula.");
                }
                const issuer = currentUser.email;

                // Basic Payload
                const payload = { 
                    user_name: u, 
                    device_tag: d, 
                    start_date: s, 
                    end_date: e, 
                    usage_type: t, 
                    usage_details: document.getElementById('usageDetails').value, 
                    status: 'Active',
                    issued_by: issuer
                };

                let { error } = await supabase.from('rekod_pinjaman').insert([payload]);

                // EXPLICIT ERROR HANDLING FOR MISSING COLUMNS
                if (error && error.message && error.message.toLowerCase().includes("column")) {
                    alert("RALAT: Kolum 'issued_by' tidak wujud dalam database. Sila tambah kolum 'issued_by' (text) dalam table 'rekod_pinjaman' di Supabase.");
                    
                    // Fallback: Try saving without the column so the loan still works
                    logDebug("Retrying without 'issued_by' column...", true);
                    const safePayload = { ...payload }; delete safePayload.issued_by;
                    const retry = await supabase.from('rekod_pinjaman').insert([safePayload]);
                    error = retry.error;
                }

                if(!error) { 
                    await supabase.from('device_inventory').update({status:'Dipinjam'}).eq('tag',d); 
                    alert("Berjaya! Pinjaman direkod."); document.getElementById('loanForm').reset(); loadLoanData(); 
                } else {
                    alert("Ralat Simpan: " + error.message);
                }
            } catch(e) {
                alert("Critical Error: " + e.message);
            }
        }

        async function submitReturn() {
            try {
                const t = document.getElementById('returnSelect').value; if(!t) return;
                
                const { data: l, error: fetchError } = await supabase.from('rekod_pinjaman').select('id').eq('device_tag', t).eq('status','Active').maybeSingle();
                
                if(fetchError) return alert("Ralat Carian: " + fetchError.message);

                if(l) {
                     // Get Receiver (Ensure we have a valid user)
                    if (!currentUser) {
                        await checkAuth();
                        if(!currentUser) return alert("Sila login semula.");
                    }
                    const receiver = currentUser.email;
                    
                    const updatePayload = { 
                        status: 'Returned', 
                        return_date: new Date(),
                        received_by: receiver 
                    };
                    
                    let { error } = await supabase.from('rekod_pinjaman').update(updatePayload).eq('id', l.id);

                     // EXPLICIT ERROR HANDLING FOR MISSING COLUMNS
                    if (error && error.message && error.message.toLowerCase().includes("column")) {
                        alert("RALAT: Kolum 'received_by' tidak wujud dalam database. Sila tambah kolum 'received_by' (text) dalam table 'rekod_pinjaman' di Supabase.");
                        
                         // Fallback
                        logDebug("Retrying without 'received_by' column...", true);
                        const safePayload = { ...updatePayload }; delete safePayload.received_by;
                        const retry = await supabase.from('rekod_pinjaman').update(safePayload).eq('id', l.id);
                        error = retry.error;
                    }

                    if(error) return alert("Ralat Update: " + error.message);

                    await supabase.from('device_inventory').update({status:'Tersedia'}).eq('tag', t);
                    alert("Dipulangkan!"); 
                    loadLoanData();
                } else {
                    alert("Tiada rekod pinjaman aktif dijumpai untuk peranti ini.");
                }
            } catch(e) {
                alert("Critical Error: " + e.message);
            }
        }

        async function loadLoanHistory() {
            const tb = document.getElementById('loan-history-body'); 
            tb.innerHTML = '<tr><td colspan="8" class="text-center"><div class="loader"></div></td></tr>';

            // Fetch loans and users in parallel to build name map
            const [ { data: loans }, { data: users } ] = await Promise.all([
                supabase.from('rekod_pinjaman').select('*').order('created_at',{ascending:false}),
                supabase.from('user_ba').select('name, emel')
            ]);
            
            // Update global cache
            if(users) {
                users.forEach(u => {
                    if(u.emel) cachedUserMap[u.emel.toLowerCase()] = u.name;
                });
            }

            currentLoanHistory = loans || [];
            tb.innerHTML = '';
            
            const today = new Date(); 
            today.setHours(0,0,0,0);

            if(loans) loans.forEach(l => {
                // Check Overdue Status
                const endDate = new Date(l.end_date);
                const isOverdue = l.status === 'Active' && endDate < today;
                const overdueClass = isOverdue ? 'bg-red-100 text-red-900 font-bold' : 'hover:bg-gray-50';

                tb.innerHTML += `
                <tr class="border-b ${overdueClass}">
                    <td class="p-3 align-top">${new Date(l.created_at).toLocaleDateString('ms-MY')}</td>
                    <td class="p-3 align-top font-medium">${l.user_name}</td>
                    <td class="p-3 align-top text-blue-600">${l.device_tag}</td>
                    <td class="p-3 align-top text-xs">${l.start_date} - ${l.end_date}</td>
                    <td class="p-3 align-top text-xs text-blue-700 font-semibold">${resolveName(l.issued_by)}</td>
                    <td class="p-3 align-top">${l.return_date?new Date(l.return_date).toLocaleDateString('ms-MY'):'-'}</td>
                    <td class="p-3 align-top text-xs text-gray-500">${resolveName(l.received_by)}</td>
                    <td class="p-3 align-top"><span class="px-2 py-1 rounded text-xs ${l.status==='Active'?'bg-green-100 text-green-800':'bg-gray-200 text-gray-800'}">${l.status}</span></td>
                </tr>`;
            });
        }

        // --- BULK / ADMIN ---
        function triggerImport() { document.getElementById('excel-upload').click(); }
        function triggerMasterUpload() { document.getElementById('master-data-upload').click(); }
        function triggerLoanUpload(t) { 
            if(t==='user') document.getElementById('loan-user-upload').click();
            if(t==='inventory') document.getElementById('loan-inventory-upload').click();
            if(t==='records') document.getElementById('loan-records-upload').click();
        }
        function handleLoanUserUpload(event) {
            const f = event.target.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = async (e) => {
                const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                const ins = [];
                json.forEach(row => {
                    const keys = Object.keys(row);
                    const name = row.name || row.Name || row.Nama || row[keys.find(k=>k.match(/name|nama/i)]);
                    const email = row.email || row.Email || row.Emel || row[keys.find(k=>k.match(/email|emel/i)]);
                    if(name) ins.push({name: name.toString().trim(), emel: email ? email.toString().trim() : ''});
                });
                if(ins.length) { 
                    const { error } = await supabase.from('user_ba').insert(ins);
                    alert(error ? error.message : `Added ${ins.length} users.`); loadLoanData();
                } else alert("No valid data.");
                event.target.value = '';
            };
            r.readAsArrayBuffer(f);
        }
        // Generic handlers for other uploads
        function handleMasterDataUpload(e) { processExcel(e.target.files[0], 'personnel', r=>({ic_number:r.IC, nama:r.Name, telefon:r.Phone, emel:r.Email, gred:r.Grade, kod_ptj:r.KodPTJ, department:r.Department})); }
        function handleFileUpload(e) { processExcel(e.target.files[0], 'rekod', r=>({ic_number:r.IC, nama:r.Name, confirmation:'TIDAK', notes:r.Notes, submitted_by:currentUser.id})); }
        function handleLoanInventoryUpload(e) { processExcel(e.target.files[0], 'device_inventory', r=>({tag:r.Tag, type:r.Type, serial:r.Serial, status:'Tersedia'})); }
        function handleLoanRecordsUpload(e) { processExcel(e.target.files[0], 'rekod_pinjaman', r=>({user_name:r.User, device_tag:r.Tag, start_date:r.Start, end_date:r.End, status:'Active'})); }

        function processExcel(f, tbl, map) {
            if(!f) return; const r = new FileReader();
            r.onload = async (e) => {
                const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
                const d = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]).map(map);
                const { error } = await supabase.from(tbl).insert(d);
                alert(error ? error.message : "Success!"); if(tbl==='rekod') fetchRecords(); if(tbl.includes('inventory')) loadLoanData();
            };
            r.readAsArrayBuffer(f);
        }

        // --- CLEAR DB ---
        function confirmClearDatabase() { clearActionType='rekod'; document.getElementById('delete-modal').classList.remove('hidden'); }
        function confirmClearMasterDatabase() { clearActionType='personnel'; document.getElementById('delete-modal').classList.remove('hidden'); }
        function confirmClearUserDatabase() { clearActionType='user_ba'; document.getElementById('delete-modal').classList.remove('hidden'); }
        function closeDeleteModal() { document.getElementById('delete-modal').classList.add('hidden'); }

        async function executeClearDatabase() {
            closeDeleteModal(); showToast("Deleting...");
            let tbl = clearActionType, col = 'id';
            if(tbl==='user_ba') col = 'name'; // FIX for user_ba
            try {
                const { error } = await supabase.from(tbl).delete().neq(col, 'X_INVALID');
                if(error) throw error;
                alert("Deleted."); if(tbl==='rekod') fetchRecords(); if(tbl==='user_ba') loadLoanData();
            } catch(e) { alert("Delete failed: "+e.message); }
        }

        // --- OVERDUE ---
        async function checkOverdueLoans() {
            showToast("Checking...");
            const { data: loans } = await supabase.from('rekod_pinjaman').select('*').eq('status','Active');
            const { data: users } = await supabase.from('user_ba').select('name, emel');
            const today = new Date(); today.setHours(0,0,0,0);
            const overdue = loans.filter(l => new Date(l.end_date) < today);
            
            const tb = document.getElementById('overdue-list-body'); tb.innerHTML = '';
            document.getElementById('no-overdue-msg').classList.toggle('hidden', overdue.length > 0);
            
            overdue.forEach(l => {
                // --- UPDATED EMAIL LOGIC ---
                const u = users.find(x => x.name.toLowerCase() === l.user_name.toLowerCase());
                
                // Prioritize user_ba email. If stored without domain (e.g. 'ali'), append @moe.gov.my. 
                // If it already has '@', treat as full email.
                // Fallback: If not in user_ba, create from username.
                let email = '';
                if (u && u.emel) {
                    const storedEmel = u.emel.trim();
                    email = storedEmel.includes('@') ? storedEmel : `${storedEmel}@moe.gov.my`;
                } else {
                    email = `${l.user_name.trim().toLowerCase().replace(/[^a-z0-9]/g,'.')}@moe.gov.my`;
                }

                const subj = encodeURIComponent("PERINGATAN: Pemulangan Peranti ICT");
                
                // --- UPDATED MESSAGE CONTENT (Less harsh) ---
                const msgBody = `Salam Sejahtera ${l.user_name},\n\n` +
                                `Merujuk perkara di atas, rekod kami menunjukkan tempoh pinjaman peranti (${l.device_tag}) telah berakhir pada ${new Date(l.end_date).toLocaleDateString('ms-MY')}.\n\n` +
                                `Mohon kerjasama tuan/puan untuk menguruskan pemulangan peranti tersebut ke Unit IT.\n\n` +
                                `Sekiranya pemulangan telah dibuat, sila abaikan notifikasi ini.\n\n` +
                                `Terima kasih.`;
                
                const body = encodeURIComponent(msgBody);
                
                tb.innerHTML += `<tr class="border-b hover:bg-orange-50"><td class="p-2">${l.user_name}</td><td class="p-2 text-blue-600 text-xs">${email}</td><td class="p-2">${l.device_tag}</td><td class="p-2 text-red-600 font-bold">${l.end_date}</td><td class="p-2 text-center"><a href="mailto:${email}?subject=${subj}&body=${body}" target="_blank" class="bg-orange-600 text-white px-3 py-1 rounded text-xs">Hantar</a></td></tr>`;
            });
            document.getElementById('overdue-modal').classList.remove('hidden');
        }

        async function addUser() { 
            const n = document.getElementById('newUserName').value; 
            const e = document.getElementById('newUserEmail').value; // Get email
            if(n) { 
                await supabase.from('user_ba').insert([{name:n, emel: e}]); 
                loadLoanData(); 
                alert("Pengguna ditambah!");
                document.getElementById('newUserName').value = '';
                document.getElementById('newUserEmail').value = '';
            } 
        }

        async function addDevice() { const t = document.getElementById('newTag').value; if(t) { await supabase.from('device_inventory').insert([{tag:t, type:document.getElementById('newType').value, serial:document.getElementById('newSerial').value, status:'Tersedia'}]); loadLoanData(); } }
        function showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.classList.remove('opacity-0','translate-y-20'); setTimeout(()=>t.classList.add('opacity-0','translate-y-20'), 3000); }
        
        // --- UPDATED EXPORT FUNCTIONS ---

        function exportToExcel() {
            if (!currentRecords || currentRecords.length === 0) {
                alert("Tiada rekod untuk diexport. Sila muat semula data.");
                return;
            }

            // Helper to reuse resolution logic
            const resolveName = (val) => {
                if(!val) return '-';
                if(cachedUserMap[val.toLowerCase()]) return cachedUserMap[val.toLowerCase()];
                if(val.includes('@')) return val.split('@')[0].replace(/[._]/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                return val;
            };

            const dataToExport = currentRecords.map(r => ({
                "Tarikh & Masa": new Date(r.created_at).toLocaleDateString('ms-MY'),
                "No. K/P": r.ic_number,
                "Nama Pegawai": r.nama,
                "Jabatan": r.department,
                "Butiran Masalah": r.notes,
                "Direkod Oleh": resolveName(r.perekod),
                "Pengesahan": r.confirmation || 'TIDAK',
                "Tarikh Kemaskini": r.status_updated_at ? new Date(r.status_updated_at).toLocaleDateString('ms-MY') : '-',
                "Dikemaskini Oleh": resolveName(r.status_updated_by)
            }));
            const ws = XLSX.utils.json_to_sheet(dataToExport);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Rekod Log");
            ws['!cols'] = [{wch: 20}, {wch: 15}, {wch: 30}, {wch: 20}, {wch: 40}, {wch: 20}, {wch: 10}, {wch: 20}, {wch: 20}];
            XLSX.writeFile(wb, `Log_Aduan_ICT_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function exportToPDF() {
            if (!currentRecords || currentRecords.length === 0) {
                alert("Tiada rekod untuk diexport. Sila muat semula data.");
                return;
            }

            const resolveName = (val) => {
                if(!val) return '-';
                if(cachedUserMap[val.toLowerCase()]) return cachedUserMap[val.toLowerCase()];
                if(val.includes('@')) return val.split('@')[0].replace(/[._]/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                return val;
            };

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4'); 
            doc.setFontSize(14); doc.text("Laporan Rekod Aduan & Panggilan ICT", 14, 15);
            doc.setFontSize(10); doc.text(`Dijana pada: ${new Date().toLocaleString('ms-MY')}`, 14, 22);
            
            const tableColumn = ["Tarikh", "IC", "Nama", "Jabatan", "Perkara", "Perekod", "Status", "Kemaskini", "Oleh"];
            
            const tableRows = currentRecords.map(r => [
                new Date(r.created_at).toLocaleDateString('ms-MY'), 
                r.ic_number, 
                r.nama, 
                r.department, 
                r.notes, 
                resolveName(r.perekod), 
                r.confirmation || 'TIDAK',
                r.status_updated_at ? new Date(r.status_updated_at).toLocaleDateString('ms-MY') : '-',
                resolveName(r.status_updated_by)
            ]);

            doc.autoTable({ 
                head: [tableColumn], 
                body: tableRows, 
                startY: 28, 
                theme: 'grid', 
                styles: { fontSize: 7, cellPadding: 2 }, 
                headStyles: { fillColor: [30, 64, 175] } 
            });
            
            doc.save(`Laporan_Log_ICT_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        function exportLoanHistoryToExcel() {
            if (!currentLoanHistory || currentLoanHistory.length === 0) {
                alert("Tiada rekod sejarah pinjaman untuk diexport.");
                return;
            }

            const today = new Date();
            today.setHours(0,0,0,0);

            const dataToExport = currentLoanHistory.map(l => {
                // Check if Active & Overdue
                const endDate = new Date(l.end_date);
                const isOverdue = l.status === 'Active' && endDate < today;
                
                // Highlight text for Excel since colors are limited in basic JS export
                const statusText = isOverdue ? "Active (LEWAT)" : l.status;

                return {
                    "Tarikh Mohon": new Date(l.created_at).toLocaleDateString('ms-MY'),
                    "Peminjam": l.user_name,
                    "Peranti": l.device_tag,
                    "Mula": l.start_date,
                    "Tamat": l.end_date,
                    "Dikeluarkan Oleh": resolveName(l.issued_by),
                    "Tarikh Pulang": l.return_date ? new Date(l.return_date).toLocaleDateString('ms-MY') : '-',
                    "Diterima Oleh": resolveName(l.received_by),
                    "Status": statusText
                };
            });

            const ws = XLSX.utils.json_to_sheet(dataToExport);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sejarah Pinjaman");
            XLSX.writeFile(wb, `Sejarah_Pinjaman_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function exportLoanHistoryToPDF() {
            if (!currentLoanHistory || currentLoanHistory.length === 0) {
                alert("Tiada rekod sejarah pinjaman untuk diexport.");
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');
            doc.setFontSize(14); doc.text("Laporan Sejarah Pinjaman ICT", 14, 15);
            doc.setFontSize(10); doc.text(`Dijana pada: ${new Date().toLocaleString('ms-MY')}`, 14, 22);

            const tableColumn = ["Tarikh Mohon", "Peminjam", "Peranti", "Mula", "Tamat", "Dikeluarkan", "Pulang", "Diterima", "Status"];
            const tableRows = [];
            const today = new Date(); 
            today.setHours(0,0,0,0);

            currentLoanHistory.forEach(l => {
                tableRows.push([
                    new Date(l.created_at).toLocaleDateString('ms-MY'),
                    l.user_name,
                    l.device_tag,
                    l.start_date,
                    l.end_date,
                    resolveName(l.issued_by),
                    l.return_date ? new Date(l.return_date).toLocaleDateString('ms-MY') : '-',
                    resolveName(l.received_by),
                    l.status
                ]);
            });

            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 28,
                theme: 'grid',
                styles: { fontSize: 8, cellPadding: 2 },
                headStyles: { fillColor: [30, 64, 175] },
                didParseCell: function(data) {
                    if (data.section === 'body') {
                        // Check original data based on row index
                        const originalRecord = currentLoanHistory[data.row.index];
                        if (originalRecord) {
                            const endDate = new Date(originalRecord.end_date);
                            const isOverdue = originalRecord.status === 'Active' && endDate < today;
                            
                            // If overdue, color row red
                            if (isOverdue) {
                                data.cell.styles.fillColor = [254, 202, 202]; // bg-red-200
                                data.cell.styles.textColor = [153, 27, 27];   // text-red-800
                                data.cell.styles.fontStyle = 'bold';
                            }
                        }
                    }
                }
            });

            doc.save(`Sejarah_Pinjaman_${new Date().toISOString().split('T')[0]}.pdf`);
        }
    </script>
</body>
</html>
